<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Livro-Interativo</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Georgia', serif;
            background: linear-gradient(to bottom, #1a2b4c 0%, #2c4a78 30%, #4a6741 70%, #2d3b2d 100%);
            color: #ffffff;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .book-cover {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Container principal baseado em SVG viewBox para manter proporções */
        .main-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* SVG principal que mantém todas as proporções */
        .main-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Todos os elementos posicionados usando viewBox do SVG */
        .positioned-element {
            position: absolute;
            transform-origin: center;
        }

        /* Título e subtítulo */
        .header {
            position: absolute;
            z-index: 100;
        }

        .title {
            font-weight: bold;
            background: linear-gradient(45deg, #4fc3f7, #81c784, #ffb74d);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(79, 195, 247, 0.3);
            margin: 0;
            line-height: 1.2;
        }

        .subtitle {
            color: #e0e0e0;
            font-style: italic;
            margin: 0;
            line-height: 1.2;
        }

        /* Botão de controle */
        .season-toggle {
            background: linear-gradient(45deg, #f44336, #e57373);
            border: none;
            color: white;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            opacity: 0.3;
            pointer-events: none;
            position: absolute;
            z-index: 200;
            font-size: 16px;
            padding: 12px 20px;
        }

        .season-toggle.active {
            opacity: 1;
            pointer-events: all;
        }

        .season-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
        }

        .season-toggle.cutting {
            background: linear-gradient(45deg, #795548, #8d6e63);
        }

        /* SVG da árvore */
        .tree-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        .root-path, .trunk-svg, .trunk-line, .branch-path {
            transition: all 0.8s ease;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .root-path.withering {
            stroke: #8d6e63;
            opacity: 0.6;
            filter: drop-shadow(0 0 5px rgba(139, 69, 19, 0.5));
            animation: wither 2s ease-in-out;
        }

        @keyframes wither {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.3; transform: scale(0.95); }
            100% { opacity: 0.6; transform: scale(0.9); }
        }

        /* Slots do Tronco */
        .trunk-slot {
            border: 2px dashed rgba(255, 193, 7, 0.6);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
            z-index: 40;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            cursor: pointer;
            position: absolute;
            font-size: 11px;
            font-weight: bold;
            padding: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            width: 100%;
            height: 100%;
        }

        .trunk-slot.disabled {
            opacity: 0.3;
            border-color: rgba(255, 193, 7, 0.2);
            color: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
        }

        .trunk-slot.highlight {
            border-color: rgba(255, 193, 7, 1);
            background: rgba(255, 193, 7, 0.1);
            transform: scale(1.02);
        }

        .trunk-slot.filled {
            background: transparent;
            border-color: rgba(255, 193, 7, 0.9);
            border-style: solid;
            color: #ffffff;
            font-weight: bold;
        }

        .trunk-slot.unavailable {
            opacity: 0.5;
            border-color: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.4);
            cursor: not-allowed;
        }

        /* Slots das Raízes */
        .root-slot {
            border: 2px dashed rgba(79, 195, 247, 0.6);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
            z-index: 50;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            position: absolute;
            font-size: 11px;
            font-weight: bold;
            padding: 6px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            width: 100%;
            height: 100%;
        }

        .root-slot.highlight {
            border-color: rgba(79, 195, 247, 1);
            background: rgba(79, 195, 247, 0.1);
            transform: scale(1.02);
        }

        .root-slot.filled {
            background: transparent;
            border-color: rgba(79, 195, 247, 0.9);
            border-style: solid;
            color: #ffffff;
            font-weight: bold;
        }

        /* Folhas SVG */
        .leaves-group ellipse {
            transition: all 1s ease;
            transform-origin: center;
            opacity: 0;
        }

        .leaves-group ellipse.visible {
            opacity: 1;
            transform: scale(1);
        }

        .leaves-group ellipse.withering {
            opacity: 0.4;
            transform: scale(0.8) translateY(20px);
            filter: sepia(0.8) hue-rotate(30deg);
        }

        /* Perguntas e Abstrações Arrastáveis */
        .question-bubble, .abstraction-bubble {
            background: rgba(0, 0, 0, 0.3);
            color: #ffffff;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: grab;
            transition: all 0.2s ease;
            font-family: 'Georgia', serif;
            text-align: center;
            user-select: none;
            position: absolute;
            touch-action: none;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255, 255, 255, 0.5);
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            width: 100%;
            height: 100%;
        }

        .question-bubble {
            border-color: rgba(79, 195, 247, 0.8);
            background: rgba(79, 195, 247, 0.2);
        }

        .abstraction-bubble {
            border-color: rgba(255, 193, 7, 0.8);
            background: rgba(255, 193, 7, 0.2);
        }

        .abstraction-bubble.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            border-color: rgba(255, 193, 7, 0.3);
            color: rgba(255, 255, 255, 0.4);
        }

        .abstraction-bubble.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.4);
        }

        .question-bubble:hover, .abstraction-bubble:hover {
            background: rgba(0, 0, 0, 0.2);
            transform: translateX(2px);
        }

        .abstraction-bubble.disabled:hover, .abstraction-bubble.unavailable:hover {
            background: transparent;
            transform: none;
        }

        .question-bubble:active, .abstraction-bubble:active {
            cursor: grabbing;
        }

        /* CÓPIA FANTASMA PARA ARRASTO */
        .drag-ghost {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            transform: scale(1.1) rotate(3deg);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5) !important;
            border-width: 3px !important;
            opacity: 0.9;
            transition: none;
        }

        .question-bubble.dragging, .abstraction-bubble.dragging {
            opacity: 0.3;
        }

        .question-bubble.placed, .abstraction-bubble.placed {
            opacity: 0.4;
            pointer-events: none;
        }

        /* Tópicos nas Folhas - USANDO SVG foreignObject para manter proporção */
                /* Tópicos nas Folhas - TAMANHO AUMENTADO */
        .leaf-topic {
            background: rgba(20, 20, 20, 0.95);
            color: #ffffff;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
            border: 1px solid rgba(79, 195, 247, 0.7);
            opacity: 0;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
            white-space: nowrap;
            padding: 6px 10px;
            font-size: 12px;
            width: auto;
            min-width: 80px;
            height: 30px;
            transform: scale(0.9);
            backdrop-filter: blur(2px);
        }

        .leaf-topic.visible {
            opacity: 1;
            transform: scale(1);
        }

        .leaf-topic:hover {
            background: rgba(79, 195, 247, 0.9);
            border-color: rgba(255, 255, 255, 0.9);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(79, 195, 247, 0.6);
            color: #ffffff;
            font-weight: bold;
            z-index: 100;
        }

        /* Animação de transição para capítulos */
        .chapter-transition {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at center, 
                rgba(79, 195, 247, 0.9) 0%, 
                rgba(79, 195, 247, 0.7) 30%, 
                rgba(26, 43, 76, 0.95) 70%, 
                rgba(0, 0, 0, 1) 100%);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transition: all 0.8s ease;
            padding: 20px;
        }

        .chapter-transition.active {
            opacity: 1;
            pointer-events: all;
        }

        .transition-content {
            text-align: center;
            color: white;
            transform: translateY(30px);
            transition: all 0.8s ease 0.2s;
        }

        .chapter-transition.active .transition-content {
            transform: translateY(0);
        }

        .transition-title {
            font-size: clamp(1.5rem, 6vw, 2.5rem);
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        .transition-subtitle {
            font-size: clamp(0.9rem, 3vw, 1.2rem);
            opacity: 0.8;
            margin-bottom: 30px;
        }

        .loading-animation {
            width: clamp(50px, 15vw, 80px);
            height: clamp(50px, 15vw, 80px);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Efeito de murcha global */
        .withering .root-path, .withering .branch-path {
            stroke: #8d6e63;
            filter: drop-shadow(0 0 3px rgba(139, 69, 19, 0.5));
        }

        .withering .trunk-svg {
            fill: #8d6e63;
        }
        .withering .trunk-line {
             stroke: #6d4c41;
        }

        .withering .question-bubble, .withering .abstraction-bubble {
            opacity: 0.7;
            border-color: rgba(139, 69, 19, 0.4);
        }

        /* Tooltip para tópicos */
        .leaf-topic::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 10px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 1000;
            max-width: 200px;
            font-weight: normal;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .leaf-topic:hover::after {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="book-cover">
        <div class="main-container">
            <!-- SVG principal para manter proporções -->
            <svg class="main-svg" viewBox="0 0 2000 1200" preserveAspectRatio="xMidYMeet">
                <defs>
                    <!-- Gradientes para elementos -->
                    <linearGradient id="titleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#4fc3f7"/>
                        <stop offset="50%" style="stop-color:#81c784"/>
                        <stop offset="100%" style="stop-color:#ffb74d"/>
                    </linearGradient>
                </defs>
                
                <!-- Título com quebra de linha -->
                <text x="50" y="80" class="title" fill="url(#titleGradient)" font-size="48" font-weight="bold" font-family="Georgia">
                    Formas Diferenciais,
                </text>
                <text x="50" y="130" class="title" fill="url(#titleGradient)" font-size="48" font-weight="bold" font-family="Georgia">
                    Topologia e Física
                </text>
                <text x="50" y="170" class="subtitle" fill="#e0e0e0" font-size="28" font-style="italic" font-family="Georgia">
                    Um Resgate Interativo à Intuição
                </text>
                
                <!-- Botão de controle -->
                <foreignObject x="1750" y="30" width="200" height="60">
                    <button class="season-toggle" id="seasonToggle" onclick="cutRoots()">
                        ✂️ Cortar Raízes
                    </button>
                </foreignObject>
                
                <!-- Solo -->
                <rect x="-1000" y="900" width="50000" height="300" fill="#8d6e63" opacity="0.8"/>
                
                <!-- Raízes -->
                <path class="root-path" d="M1000 900 C 985 920, 975 950, 970 980 C 965 1010, 960 1040, 955 1070 C 950 1100, 945 1130, 940 1160 C 935 1180, 930 1195, 925 1200" stroke="#5d4037" stroke-width="6" fill="none" stroke-linecap="round"/>
                <path class="root-path" d="M1000 900 C 1015 920, 1025 950, 1030 980 C 1035 1010, 1040 1040, 1045 1070 C 1050 1100, 1055 1130, 1060 1160 C 1065 1180, 1070 1195, 1075 1200" stroke="#5d4037" stroke-width="6" fill="none" stroke-linecap="round"/>
                <path class="root-path" d="M1000 900 C 950 920, 900 945, 850 975 C 820 995, 790 1020, 760 1050 C 730 1080, 700 1110, 670 1140 C 650 1160, 630 1180, 610 1200" stroke="#4e342e" stroke-width="4" fill="none" stroke-linecap="round"/>
                <path class="root-path" d="M1000 900 C 1050 920, 1100 945, 1150 975 C 1180 995, 1210 1020, 1240 1050 C 1270 1080, 1300 1110, 1330 1140 C 1350 1160, 1370 1180, 1390 1200" stroke="#4e342e" stroke-width="4" fill="none" stroke-linecap="round"/>
                <path class="root-path" d="M850 975 C 830 990, 810 1010, 795 1035 C 780 1060, 765 1085, 750 1110 C 735 1135, 720 1160, 705 1185 C 695 1192, 685 1196, 675 1200" stroke="#3e2723" stroke-width="3" fill="none" stroke-linecap="round"/>
                <path class="root-path" d="M1150 975 C 1170 990, 1190 1010, 1205 1035 C 1220 1060, 1235 1085, 1250 1110 C 1265 1135, 1280 1160, 1295 1185 C 1305 1192, 1315 1196, 1325 1200" stroke="#3e2723" stroke-width="3" fill="none" stroke-linecap="round"/>
                
                <!-- Tronco -->
                <path class="trunk-svg" d="M960 900 Q 950 700 950 500 T 960 100 L 1040 100 Q 1050 500 1050 700 T 1040 900 Z" fill="#8d6e63"/>
                <line class="trunk-line" x1="1000" y1="120" x2="1000" y2="880" stroke="#6d4c41" stroke-width="8" />
                
                <!-- Linhas de segmentação do tronco -->
                <line class="trunk-line" x1="960" y1="720" x2="1040" y2="720" stroke="#6d4c41" stroke-width="4" opacity="0.7" />
                <line class="trunk-line" x1="960" y1="540" x2="1040" y2="540" stroke="#6d4c41" stroke-width="4" opacity="0.7" />
                <line class="trunk-line" x1="960" y1="360" x2="1040" y2="360" stroke="#6d4c41" stroke-width="4" opacity="0.7" />
                <line class="trunk-line" x1="960" y1="180" x2="1040" y2="180" stroke="#6d4c41" stroke-width="4" opacity="0.7" />
                
                <!-- Galhos -->
                <g class="branches-group">
                    <path class="branch-path" d="M1000 450 C 975 400, 825 280, 725 150" stroke="#6d4c41" stroke-width="35" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M1000 450 C 1025 400, 1175 280, 1275 150" stroke="#6d4c41" stroke-width="35" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M1000 300 C 925 250, 850 180, 790 120" stroke="#6d4c41" stroke-width="28" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M1000 300 C 1075 250, 1150 180, 1210 120" stroke="#6d4c41" stroke-width="28" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M1000 200 C 963 150, 888 80, 838 50" stroke="#6d4c41" stroke-width="25" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M1000 200 C 1037 150, 1112 80, 1162 50" stroke="#6d4c41" stroke-width="25" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M825 280 C 775 230, 705 170, 645 140" stroke="#6d4c41" stroke-width="18" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M790 120 C 755 90, 715 50, 685 30" stroke="#6d4c41" stroke-width="18" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M975 400 C 925 350, 848 280, 805 240" stroke="#6d4c41" stroke-width="20" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M1175 280 C 1225 230, 1295 170, 1355 140" stroke="#6d4c41" stroke-width="18" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M1210 120 C 1245 90, 1285 50, 1315 30" stroke="#6d4c41" stroke-width="18" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M1025 400 C 1075 350, 1152 280, 1195 240" stroke="#6d4c41" stroke-width="20" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M725 150 C 675 120, 610 80, 565 60" stroke="#6d4c41" stroke-width="15" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M1275 150 C 1325 120, 1390 80, 1435 60" stroke="#6d4c41" stroke-width="15" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M645 140 C 615 110, 575 70, 545 50" stroke="#6d4c41" stroke-width="12" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M1355 140 C 1385 110, 1425 70, 1455 50" stroke="#6d4c41" stroke-width="12" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M838 50 C 815 30, 785 10, 763 5" stroke="#6d4c41" stroke-width="10" fill="none" stroke-linecab="round"/>
                    <path class="branch-path" d="M1162 50 C 1185 30, 1215 10, 1237 5" stroke="#6d4c41" stroke-width="10" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M805 240 C 765 200, 718 150, 685 120" stroke="#6d4c41" stroke-width="14" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M1195 240 C 1235 200, 1282 150, 1315 120" stroke="#6d4c41" stroke-width="14" fill="none" stroke-linecap="round"/>
                </g>

                <!-- FOLHAS - Muito mais densas com folhas GRANDES -->
                <g class="leaves-group" id="leavesGroup">
                    <!-- Folhas principais GRANDES (40-50px de raio) -->
                    <ellipse cx="975" cy="425" rx="48" ry="35" fill="#4caf50"/>
                    <ellipse cx="1025" cy="425" rx="48" ry="35" fill="#4caf50"/>
                    <ellipse cx="950" cy="390" rx="45" ry="32" fill="#66bb6a"/>
                    <ellipse cx="1050" cy="390" rx="45" ry="32" fill="#66bb6a"/>
                    <ellipse cx="900" cy="340" rx="50" ry="36" fill="#4caf50"/>
                    <ellipse cx="1100" cy="340" rx="50" ry="36" fill="#4caf50"/>
                    <ellipse cx="875" cy="310" rx="42" ry="30" fill="#81c784"/>
                    <ellipse cx="1125" cy="310" rx="42" ry="30" fill="#81c784"/>
                    
                    <!-- Folhas grandes no meio do tronco -->
                    <ellipse cx="970" cy="460" rx="45" ry="32" fill="#4caf50"/>
                    <ellipse cx="1030" cy="460" rx="45" ry="32" fill="#4caf50"/>
                    <ellipse cx="960" cy="480" rx="40" ry="28" fill="#66bb6a"/>
                    <ellipse cx="1040" cy="480" rx="40" ry="28" fill="#66bb6a"/>
                    <ellipse cx="980" cy="500" rx="38" ry="26" fill="#81c784"/>
                    <ellipse cx="1020" cy="500" rx="38" ry="26" fill="#81c784"/>
                    
                    <!-- Folhas grandes na copa superior -->
                    <ellipse cx="940" cy="250" rx="46" ry="33" fill="#4caf50"/>
                    <ellipse cx="1060" cy="250" rx="46" ry="33" fill="#4caf50"/>
                    <ellipse cx="920" cy="200" rx="44" ry="31" fill="#66bb6a"/>
                    <ellipse cx="1080" cy="200" rx="44" ry="31" fill="#66bb6a"/>
                    <ellipse cx="950" cy="160" rx="42" ry="29" fill="#81c784"/>
                    <ellipse cx="1050" cy="160" rx="42" ry="29" fill="#81c784"/>
                    <ellipse cx="980" cy="130" rx="40" ry="27" fill="#a5d6a7"/>
                    <ellipse cx="1020" cy="130" rx="40" ry="27" fill="#a5d6a7"/>

                    <!-- Folhas grandes nos galhos principais -->
                    <ellipse cx="825" cy="280" rx="50" ry="36" fill="#4caf50"/>
                    <ellipse cx="1175" cy="280" rx="50" ry="36" fill="#4caf50"/>
                    <ellipse cx="800" cy="250" rx="48" ry="34" fill="#66bb6a"/>
                    <ellipse cx="1200" cy="250" rx="48" ry="34" fill="#66bb6a"/>
                    <ellipse cx="775" cy="220" rx="46" ry="32" fill="#a5d6a7"/>
                    <ellipse cx="1225" cy="220" rx="46" ry="32" fill="#a5d6a7"/>
                    <ellipse cx="750" cy="185" rx="44" ry="30" fill="#4caf50"/>
                    <ellipse cx="1250" cy="185" rx="44" ry="30" fill="#4caf50"/>
                    <ellipse cx="725" cy="150" rx="48" ry="34" fill="#66bb6a"/>
                    <ellipse cx="1275" cy="150" rx="48" ry="34" fill="#66bb6a"/>

                    <!-- Folhas grandes secundárias -->
                    <ellipse cx="925" cy="275" rx="44" ry="31" fill="#66bb6a"/>
                    <ellipse cx="1075" cy="275" rx="44" ry="31" fill="#66bb6a"/>
                    <ellipse cx="900" cy="240" rx="46" ry="33" fill="#4caf50"/>
                    <ellipse cx="1100" cy="240" rx="46" ry="33" fill="#4caf50"/>
                    <ellipse cx="875" cy="210" rx="42" ry="29" fill="#81c784"/>
                    <ellipse cx="1125" cy="210" rx="42" ry="29" fill="#81c784"/>
                    <ellipse cx="850" cy="180" rx="48" ry="34" fill="#a5d6a7"/>
                    <ellipse cx="1150" cy="180" rx="48" ry="34" fill="#a5d6a7"/>
                    <ellipse cx="820" cy="150" rx="44" ry="31" fill="#4caf50"/>
                    <ellipse cx="1180" cy="150" rx="44" ry="31" fill="#4caf50"/>
                    <ellipse cx="790" cy="120" rx="50" ry="36" fill="#66bb6a"/>
                    <ellipse cx="1210" cy="120" rx="50" ry="36" fill="#66bb6a"/>

                    <!-- Folhas grandes terciárias preenchendo espaços -->
                    <ellipse cx="963" cy="175" rx="40" ry="28" fill="#4caf50"/>
                    <ellipse cx="1037" cy="175" rx="40" ry="28" fill="#4caf50"/>
                    <ellipse cx="930" cy="125" rx="42" ry="30" fill="#66bb6a"/>
                    <ellipse cx="1070" cy="125" rx="42" ry="30" fill="#66bb6a"/>
                    <ellipse cx="900" cy="95" rx="38" ry="26" fill="#81c784"/>
                    <ellipse cx="1100" cy="95" rx="38" ry="26" fill="#81c784"/>
                    <ellipse cx="870" cy="70" rx="44" ry="31" fill="#a5d6a7"/>
                    <ellipse cx="1130" cy="70" rx="44" ry="31" fill="#a5d6a7"/>
                    <ellipse cx="838" cy="50" rx="40" ry="28" fill="#4caf50"/>
                    <ellipse cx="1162" cy="50" rx="40" ry="28" fill="#4caf50"/>

                    <!-- Folhas grandes espalhadas preenchendo lacunas -->
                    <ellipse cx="775" cy="255" rx="38" ry="26" fill="#66bb6a"/>
                    <ellipse cx="1225" cy="255" rx="38" ry="26" fill="#66bb6a"/>
                    <ellipse cx="740" cy="200" rx="40" ry="28" fill="#4caf50"/>
                    <ellipse cx="1260" cy="200" rx="40" ry="28" fill="#4caf50"/>
                    <ellipse cx="720" cy="175" rx="36" ry="25" fill="#81c784"/>
                    <ellipse cx="1280" cy="175" rx="36" ry="25" fill="#81c784"/>
                    <ellipse cx="685" cy="155" rx="42" ry="30" fill="#a5d6a7"/>
                    <ellipse cx="1315" cy="155" rx="42" ry="30" fill="#a5d6a7"/>
                    <ellipse cx="645" cy="140" rx="38" ry="26" fill="#66bb6a"/>
                    <ellipse cx="1355" cy="140" rx="38" ry="26" fill="#66bb6a"/>

                    <!-- Folhas grandes extremidades -->
                    <ellipse cx="565" cy="60" rx="36" ry="25" fill="#4caf50"/>
                    <ellipse cx="1435" cy="60" rx="36" ry="25" fill="#4caf50"/>

                    <!-- Preenchimento adicional com folhas médias/grandes -->
                    <ellipse cx="880" cy="320" rx="35" ry="24" fill="#4caf50"/>
                    <ellipse cx="1120" cy="320" rx="35" ry="24" fill="#4caf50"/>
                    <ellipse cx="860" cy="300" rx="37" ry="26" fill="#66bb6a"/>
                    <ellipse cx="1140" cy="300" rx="37" ry="26" fill="#66bb6a"/>
                    <ellipse cx="840" cy="270" rx="35" ry="24" fill="#81c784"/>
                    <ellipse cx="1160" cy="270" rx="35" ry="24" fill="#81c784"/>
                    <ellipse cx="810" cy="240" rx="39" ry="27" fill="#a5d6a7"/>
                    <ellipse cx="1190" cy="240" rx="39" ry="27" fill="#a5d6a7"/>
                    <ellipse cx="785" cy="210" rx="36" ry="25" fill="#4caf50"/>
                    <ellipse cx="1215" cy="210" rx="36" ry="25" fill="#4caf50"/>
                    <ellipse cx="760" cy="170" rx="38" ry="26" fill="#66bb6a"/>
                    <ellipse cx="1240" cy="170" rx="38" ry="26" fill="#66bb6a"/>
                    <ellipse cx="735" cy="140" rx="35" ry="24" fill="#81c784"/>
                    <ellipse cx="1265" cy="140" rx="35" ry="24" fill="#81c784"/>
                    <ellipse cx="710" cy="110" rx="33" ry="23" fill="#a5d6a7"/>
                    <ellipse cx="1290" cy="110" rx="33" ry="23" fill="#a5d6a7"/>
                    <ellipse cx="680" cy="85" rx="36" ry="25" fill="#4caf50"/>
                    <ellipse cx="1320" cy="85" rx="36" ry="25" fill="#4caf50"/>
                    <ellipse cx="650" cy="65" rx="33" ry="23" fill="#66bb6a"/>
                    <ellipse cx="1350" cy="65" rx="33" ry="23" fill="#66bb6a"/>
                    <ellipse cx="620" cy="45" rx="35" ry="24" fill="#81c784"/>
                    <ellipse cx="1380" cy="45" rx="35" ry="24" fill="#81c784"/>
                    <ellipse cx="595" cy="35" rx="32" ry="22" fill="#a5d6a7"/>
                    <ellipse cx="1405" cy="35" rx="32" ry="22" fill="#a5d6a7"/>
                    <ellipse cx="575" cy="25" rx="34" ry="23" fill="#4caf50"/>
                    <ellipse cx="1425" cy="25" rx="34" ry="23" fill="#4caf50"/>

                    <!-- Mais folhas grandes para cobrir completamente os galhos -->
                    <ellipse cx="845" cy="230" rx="37" ry="26" fill="#81c784"/>
                    <ellipse cx="1155" cy="230" rx="37" ry="26" fill="#81c784"/>
                    <ellipse cx="815" cy="200" rx="35" ry="24" fill="#4caf50"/>
                    <ellipse cx="1185" cy="200" rx="35" ry="24" fill="#4caf50"/>
                    <ellipse cx="780" cy="170" rx="38" ry="26" fill="#66bb6a"/>
                    <ellipse cx="1220" cy="170" rx="38" ry="26" fill="#66bb6a"/>
                    <ellipse cx="755" cy="140" rx="36" ry="25" fill="#81c784"/>
                    <ellipse cx="1245" cy="140" rx="36" ry="25" fill="#81c784"/>
                    <ellipse cx="730" cy="110" rx="34" ry="23" fill="#a5d6a7"/>
                    <ellipse cx="1270" cy="110" rx="34" ry="23" fill="#a5d6a7"/>
                    <ellipse cx="700" cy="85" rx="37" ry="26" fill="#4caf50"/>
                    <ellipse cx="1300" cy="85" rx="37" ry="26" fill="#4caf50"/>
                    <ellipse cx="670" cy="65" rx="35" ry="24" fill="#66bb6a"/>
                    <ellipse cx="1330" cy="65" rx="35" ry="24" fill="#66bb6a"/>
                    <ellipse cx="640" cy="50" rx="33" ry="23" fill="#81c784"/>
                    <ellipse cx="1360" cy="50" rx="33" ry="23" fill="#81c784"/>

                    <!-- Folhas nos galhos mais finos -->
                    <ellipse cx="600" cy="40" rx="30" ry="21" fill="#66bb6a"/>
                    <ellipse cx="1400" cy="40" rx="30" ry="21" fill="#66bb6a"/>
                    <ellipse cx="580" cy="30" rx="28" ry="19" fill="#4caf50"/>
                    <ellipse cx="1420" cy="30" rx="28" ry="19" fill="#4caf50"/>
                    <ellipse cx="550" cy="25" rx="29" ry="20" fill="#81c784"/>
                    <ellipse cx="1450" cy="25" rx="29" ry="20" fill="#81c784"/>

                    <!-- Preenchimento central da copa -->
                    <ellipse cx="985" cy="330" rx="32" ry="22" fill="#4caf50"/>
                    <ellipse cx="1015" cy="325" rx="33" ry="23" fill="#66bb6a"/>
                    <ellipse cx="990" cy="310" rx="31" ry="21" fill="#81c784"/>
                    <ellipse cx="1010" cy="315" rx="34" ry="24" fill="#a5d6a7"/>
                    <ellipse cx="975" cy="290" rx="32" ry="22" fill="#4caf50"/>
                    <ellipse cx="1025" cy="295" rx="33" ry="23" fill="#66bb6a"/>
                    <ellipse cx="970" cy="270" rx="31" ry="21" fill="#81c784"/>
                    <ellipse cx="1030" cy="275" rx="32" ry="22" fill="#a5d6a7"/>

                    <!-- Folhas adicionais extremamente densas -->
                    <ellipse cx="940" cy="350" rx="30" ry="21" fill="#4caf50"/>
                    <ellipse cx="1060" cy="350" rx="30" ry="21" fill="#4caf50"/>
                    <ellipse cx="920" cy="320" rx="32" ry="22" fill="#66bb6a"/>
                    <ellipse cx="1080" cy="320" rx="32" ry="22" fill="#66bb6a"/>
                    <ellipse cx="910" cy="290" rx="29" ry="20" fill="#81c784"/>
                    <ellipse cx="1090" cy="290" rx="29" ry="20" fill="#81c784"/>
                    <ellipse cx="890" cy="260" rx="31" ry="21" fill="#a5d6a7"/>
                    <ellipse cx="1110" cy="260" rx="31" ry="21" fill="#a5d6a7"/>

                    <!-- Folhas grandes cobrindo o topo do tronco -->
                    <ellipse cx="965" cy="140" rx="38" ry="26" fill="#4caf50"/>
                    <ellipse cx="1035" cy="140" rx="38" ry="26" fill="#4caf50"/>
                    <ellipse cx="975" cy="110" rx="36" ry="25" fill="#66bb6a"/>
                    <ellipse cx="1025" cy="110" rx="36" ry="25" fill="#66bb6a"/>
                    <ellipse cx="985" cy="85" rx="34" ry="23" fill="#81c784"/>
                    <ellipse cx="1015" cy="85" rx="34" ry="23" fill="#81c784"/>
                    <ellipse cx="995" cy="60" rx="32" ry="22" fill="#a5d6a7"/>
                    <ellipse cx="1005" cy="60" rx="32" ry="22" fill="#a5d6a7"/>
                </g>

                <!-- Slots das Raízes usando foreignObject para manter proporção -->
                <foreignObject x="650" y="1030" width="120" height="60">
                    <div class="root-slot" id="slot1">Arraste aqui</div>
                </foreignObject>
                <foreignObject x="940" y="1030" width="120" height="60">
                    <div class="root-slot" id="slot2">Arraste aqui</div>
                </foreignObject>
                <foreignObject x="1230" y="1030" width="120" height="60">
                    <div class="root-slot" id="slot3">Arraste aqui</div>
                </foreignObject>

                <!-- Slots do Tronco usando foreignObject -->
                <foreignObject x="920" y="660" width="160" height="80">
                    <div class="trunk-slot disabled" id="trunkSlot1" data-order="1" data-abstraction="intuition">
                        Complete as raízes primeiro
                    </div>
                </foreignObject>
                <foreignObject x="920" y="480" width="160" height="80">
                    <div class="trunk-slot unavailable" id="trunkSlot2" data-order="2" data-abstraction="geometry">
                        Coloque "Intuição" primeiro
                    </div>
                </foreignObject>
                <foreignObject x="920" y="300" width="160" height="80">
                    <div class="trunk-slot unavailable" id="trunkSlot3" data-order="3" data-abstraction="analysis">
                        Coloque "Geometria/Física" primeiro
                    </div>
                </foreignObject>
                <foreignObject x="920" y="120" width="160" height="80">
                    <div class="trunk-slot unavailable" id="trunkSlot4" data-order="4" data-abstraction="topology">
                        Coloque "Analogias" primeiro
                    </div>
                </foreignObject>

                <!-- Perguntas Arrastáveis -->
                <foreignObject x="50" y="800" width="120" height="50">
                    <div class="question-bubble" draggable="true" data-question="integral">
                        O que é?
                    </div>
                </foreignObject>
                <foreignObject x="200" y="800" width="120" height="50">
                    <div class="question-bubble" draggable="true" data-question="area">
                        Como?
                    </div>
                </foreignObject>
                <foreignObject x="350" y="800" width="120" height="50">
                    <div class="question-bubble" draggable="true" data-question="parts">
                        Por que?
                    </div>
                </foreignObject>

                <!-- Abstrações Arrastáveis -->
                <foreignObject x="50" y="650" width="140" height="50">
                    <div class="abstraction-bubble disabled" draggable="false" data-abstraction="intuition">
                        Intuição
                    </div>
                </foreignObject>
                <foreignObject x="50" y="700" width="140" height="50">
                    <div class="abstraction-bubble disabled" draggable="false" data-abstraction="geometry">
                        Geometria/Física
                    </div>
                </foreignObject>
                <foreignObject x="200" y="650" width="140" height="50">
                    <div class="abstraction-bubble disabled" draggable="false" data-abstraction="analysis">
                        Analogias
                    </div>
                </foreignObject>
                <foreignObject x="200" y="700" width="140" height="50">
                    <div class="abstraction-bubble disabled" draggable="false" data-abstraction="topology">
                        Abstração
                    </div>
                </foreignObject>

                <!-- Tópicos das Folhas usando foreignObject - POSICIONADOS SOBRE AS FOLHAS -->
                <foreignObject x="560" y="50" width="80" height="25">
                    <div class="leaf-topic" data-tooltip="Introdução ao cálculo integral avançado">1. Introdução</div>
                </foreignObject>
                <foreignObject x="640" y="130" width="90" height="25">
                    <div class="leaf-topic" data-tooltip="Integrais sobre elementos de área e volume">2. Integrais</div>
                </foreignObject>
                <foreignObject x="720" y="140" width="80" height="25">
                    <div class="leaf-topic" data-tooltip="Aplicações na mecânica clássica">3. Mecânica</div>
                </foreignObject>
                <foreignObject x="785" y="110" width="90" height="25">
                    <div class="leaf-topic" data-tooltip="Trabalho e energia no espaço tridimensional">4. Trabalho</div>
                </foreignObject>
                <foreignObject x="820" y="270" width="90" height="25">
                    <div class="leaf-topic" data-tooltip="Integral de linha e variação angular">5. Variação</div>
                </foreignObject>
                <foreignObject x="845" y="170" width="80" height="25">
                    <div class="leaf-topic" data-tooltip="Teoria dos campos vetoriais">6. Campos</div>
                </foreignObject>
                <foreignObject x="895" y="230" width="90" height="25">
                    <div class="leaf-topic" data-tooltip="Conceitos de ângulo sólido">7. Ângulo</div>
                </foreignObject>
                <foreignObject x="920" y="265" width="90" height="25">
                    <div class="leaf-topic" data-tooltip="Determinantes e transformações">8. Determinante</div>
                </foreignObject>
                <foreignObject x="970" y="415" width="100" height="25">
                    <div class="leaf-topic" data-tooltip="Revisitando conceitos de trabalho">9. Voltando</div>
                </foreignObject>
                <foreignObject x="1020" y="415" width="80" height="25">
                    <div class="leaf-topic" data-tooltip="Teoria de bordos e fronteiras">10. Bordo</div>
                </foreignObject>
                <foreignObject x="1070" y="265" width="90" height="25">
                    <div class="leaf-topic" data-tooltip="Extensões da teoria do trabalho">11. Trabalho 2</div>
                </foreignObject>
                <foreignObject x="1095" y="230" width="90" height="25">
                    <div class="leaf-topic" data-tooltip="Teorema fundamental de Stokes">12. Stokes</div>
                </foreignObject>
                <foreignObject x="1145" y="170" width="80" height="25">
                    <div class="leaf-topic" data-tooltip="Teorema de Green no plano">13. Green</div>
                </foreignObject>
                <foreignObject x="1170" y="270" width="90" height="25">
                    <div class="leaf-topic" data-tooltip="Nova perspectiva sobre derivadas">14. Derivada</div>
                </foreignObject>
                <foreignObject x="1205" y="110" width="90" height="25">
                    <div class="leaf-topic" data-tooltip="Teorema da divergência de Gauss">15. Divergência</div>
                </foreignObject>
                <foreignObject x="1270" y="140" width="90" height="25">
                    <div class="leaf-topic" data-tooltip="Fundamentos da álgebra exterior">16. Álgebra</div>
                </foreignObject>
                <foreignObject x="1350" y="130" width="80" height="25">
                    <div class="leaf-topic" data-tooltip="Operações de pullback">17. Pullback</div>
                </foreignObject>
                <foreignObject x="833" y="40" width="90" height="25">
                    <div class="leaf-topic" data-tooltip="Curvas e superfícies paramétricas">Apêndice A</div>
                </foreignObject>
                <foreignObject x="1157" y="40" width="90" height="25">
                    <div class="leaf-topic" data-tooltip="Derivada como aproximação linear">Apêndice B</div>
                </foreignObject>
                <foreignObject x="1430" y="50" width="90" height="25">
                    <div class="leaf-topic" data-tooltip="Gradientes e derivadas direcionais">Apêndice C</div>
                </foreignObject>
            </svg>
        </div>

        <!-- Animação de transição para capítulos -->
        <div class="chapter-transition" id="chapterTransition">
            <div class="transition-content">
                <div class="transition-title" id="transitionTitle">Carregando...</div>
                <div class="transition-subtitle" id="transitionSubtitle">Preparando o capítulo</div>
                <div class="loading-animation"></div>
            </div>
        </div>
    </div>

    <script>
        let isWithering = false;
        let rootQuestionsPlaced = 0;
        let trunkAbstractionsPlaced = 0;
        let currentStage = 1;
        let draggedElement = null;
        let dragGhost = null;
        
        const abstractionOrder = ['intuition', 'geometry', 'analysis', 'topology'];
        const placedAbstractions = [];
        
        // Tópicos do livro
        const topics = [
            {
                title: "1. Introdução",
                link: "capitulos/cap1.html",
                tooltip: "Introdução ao cálculo integral avançado"
            },
            {
                title: "2. Integrais sobre Elementos",
                link: "capitulos/cap2.html",
                tooltip: "Integrais sobre elementos de área e volume"
            },
            {
                title: "3. Mecânica",
                link: "capitulos/cap3.html",
                tooltip: "Aplicações na mecânica clássica"
            },
            {
                title: "4. Trabalho e Energia",
                link: "capitulos/cap4.html",
                tooltip: "Trabalho e energia no espaço tridimensional"
            },
            {
                title: "5. Variação de Ângulo",
                link: "capitulos/cap5.html",
                tooltip: "Integral de linha e variação angular"
            },
            {
                title: "6. Campos - Fluxos",
                link: "capitulos/cap6.html",
                tooltip: "Teoria dos campos vetoriais"
            },
            {
                title: "7. Ângulo Sólido",
                link: "capitulos/cap7.html",
                tooltip: "Conceitos de ângulo sólido"
            },
            {
                title: "8. Determinante",
                link: "capitulos/cap8.html",
                tooltip: "Determinantes e transformações"
            },
            {
                title: "9. Voltando ao Trabalho",
                link: "capitulos/cap9.html",
                tooltip: "Revisitando conceitos de trabalho"
            },
            {
                title: "10. Bordo",
                link: "capitulos/cap10.html",
                tooltip: "Teoria de bordos e fronteiras"
            },
            {
                title: "11. Trabalho: Parte 2",
                link: "capitulos/cap11.html",
                tooltip: "Extensões da teoria do trabalho"
            },
            {
                title: "12. Teorema de Stokes",
                link: "capitulos/cap12.html",
                tooltip: "Teorema fundamental de Stokes"
            },
            {
                title: "13. Teorema de Green",
                link: "capitulos/cap13.html",
                tooltip: "Teorema de Green no plano"
            },
            {
                title: "14. Reinterpretando a Derivada",
                link: "capitulos/cap14.html",
                tooltip: "Nova perspectiva sobre derivadas"
            },
            {
                title: "15. Teorema da Divergência",
                link: "capitulos/cap15.html",
                tooltip: "Teorema da divergência de Gauss"
            },
            {
                title: "16. Álgebra Exterior",
                link: "capitulos/cap16.html",
                tooltip: "Fundamentos da álgebra exterior"
            },
            {
                title: "17. Pullback",
                link: "capitulos/cap17.html",
                tooltip: "Operações de pullback"
            },
            {
                title: "Apêndice A - Curvas",
                link: "capitulos/apendice-a.html",
                tooltip: "Curvas e superfícies paramétricas"
            },
            {
                title: "Apêndice B - Derivadas",
                link: "capitulos/apendice-b.html",
                tooltip: "Derivada como aproximação linear"
            },
            {
                title: "Apêndice C - Gradientes",
                link: "capitulos/apendice-c.html",
                tooltip: "Gradientes e derivadas direcionais"
            }
        ];

        function navigateToChapter(topic) {
            const transition = document.getElementById('chapterTransition');
            const title = document.getElementById('transitionTitle');
            const subtitle = document.getElementById('transitionSubtitle');
            
            title.textContent = topic.title;
            subtitle.textContent = topic.tooltip;
            
            transition.classList.add('active');
            
            setTimeout(() => {
                window.location.href = topic.link;
            }, 2000);
        }

        function updateTrunkSlotAvailability() {
            const slots = document.querySelectorAll('.trunk-slot');
            const bubbles = document.querySelectorAll('.abstraction-bubble');
            
            const nextOrder = trunkAbstractionsPlaced + 1;
            
            slots.forEach(slot => {
                const slotOrder = parseInt(slot.dataset.order);
                const slotAbstraction = slot.dataset.abstraction;
                
                if (slotOrder === nextOrder && !slot.classList.contains('filled')) {
                    slot.classList.remove('disabled', 'unavailable');
                    slot.textContent = 'Arraste o nome da camada';
                    
                    bubbles.forEach(bubble => {
                        if (bubble.dataset.abstraction === slotAbstraction) {
                            bubble.classList.remove('disabled', 'unavailable');
                            bubble.draggable = true;
                        } else if (!bubble.classList.contains('placed')) {
                            bubble.classList.add('unavailable');
                            bubble.draggable = false;
                        }
                    });
                } else if (slotOrder > nextOrder && !slot.classList.contains('filled')) {
                    slot.classList.add('unavailable');
                    slot.classList.remove('disabled');
                    
                    const nextAbstraction = abstractionOrder[nextOrder - 1];
                    slot.textContent = `Coloque "${getAbstractionName(nextAbstraction)}" primeiro`;
                }
            });
        }

        function getAbstractionName(abstraction) {
            const names = {
                'intuition': 'Intuição',
                'geometry': 'Geometria/Física',
                'analysis': 'Analogias',
                'topology': 'Abstração'
            };
            return names[abstraction] || abstraction;
        }

        function enableTrunkSlots() {
            updateTrunkSlotAvailability();
        }

        function handleRootQuestionPlacement() {
            rootQuestionsPlaced++;
            
            if (rootQuestionsPlaced === 3) {
                currentStage = 2;
                enableTrunkSlots();
                // Revela mais folhas na base
                revealLeaves(15); // Aumentado de 8 para 15
            }
        }
        
        function handleTrunkAbstractionPlacement(abstractionType) {
            trunkAbstractionsPlaced++;
            placedAbstractions.push(abstractionType);
            
            // Aumenta significativamente a quantidade de folhas reveladas a cada etapa
            const leavesToReveal = 15 + trunkAbstractionsPlaced * 20; // De 5 para 20
            revealLeaves(leavesToReveal);
            
            updateTrunkSlotAvailability();
            
            if (trunkAbstractionsPlaced === 4) {
                currentStage = 3;
                document.getElementById('seasonToggle').classList.add('active');
                
                setTimeout(() => {
                    const allLeaves = document.querySelectorAll('.leaves-group ellipse');
                    const allTopics = document.querySelectorAll('.leaf-topic');
                    
                    // Ordenar folhas por posição Y (da base para o topo)
                    const leavesWithY = Array.from(allLeaves).map((leaf, index) => ({
                        element: leaf,
                        y: parseFloat(leaf.getAttribute('cy')),
                        index: index
                    }));
                    
                    // Ordenar por Y decrescente (da base para o topo) com prioridade para folhas mais altas
                    leavesWithY.sort((a, b) => {
                        // Dá mais peso às folhas mais altas (menor Y)
                        const aWeight = a.y * 0.7; // Folhas mais altas aparecem antes
                        const bWeight = b.y * 0.7;
                        return aWeight - bWeight;
                    });
                    
                    leavesWithY.forEach((leafData, i) => {
                        setTimeout(() => {
                            leafData.element.classList.add('visible');
                            if (allTopics[leafData.index]) {
                                allTopics[leafData.index].classList.add('visible');
                            }
                        }, i * 10); // Acelerado de 15 para 10ms
                    });
                }, 500);
            }
        }

        function revealLeaves(count) {
            const leaves = document.querySelectorAll('.leaves-group ellipse');
            const topics = document.querySelectorAll('.leaf-topic');
            
            const toReveal = Math.min(count, leaves.length);
            
            // Ordenar folhas por posição Y com ênfase nas mais altas
            const leavesWithY = Array.from(leaves).map((leaf, index) => ({
                element: leaf,
                y: parseFloat(leaf.getAttribute('cy')),
                index: index
            }));
            
            // Prioriza folhas mais altas (menor Y) mas mantém alguma distribuição
            leavesWithY.sort((a, b) => {
                // Folhas mais altas (menor Y) têm prioridade, mas com variação
                if (Math.abs(a.y - b.y) < 50) {
                    return 0.5 - Math.random(); // Aleatoriedade para folhas próximas
                }
                return a.y - b.y;
            });
            
            // Revela primeiro as folhas mais altas, mas com distribuição
            for (let i = 0; i < toReveal; i++) {
                setTimeout(() => {
                    const leafData = leavesWithY[i];
                    leafData.element.classList.add('visible');
                    
                    // Revela o tópico correspondente
                    if (topics[leafData.index]) {
                        topics[leafData.index].classList.add('visible');
                    }
                }, i * 20); // Tempo entre revelações
            }
        }

        // Sistema de Drag and Drop COM FANTASMA VISUAL
        let isDragging = false;
        let currentDragElement = null;
        let offset = { x: 0, y: 0 };

        function createDragGhost(originalElement) {
            const ghost = originalElement.cloneNode(true);
            ghost.classList.add('drag-ghost');
            ghost.style.width = originalElement.offsetWidth + 'px';
            ghost.style.height = originalElement.offsetHeight + 'px';
            document.body.appendChild(ghost);
            return ghost;
        }

        function initializeDragAndDrop() {
            const questions = document.querySelectorAll('.question-bubble');
            const abstractions = document.querySelectorAll('.abstraction-bubble');
            const rootSlots = document.querySelectorAll('.root-slot');
            const trunkSlots = document.querySelectorAll('.trunk-slot');

            questions.forEach(question => {
                question.addEventListener('mousedown', startDrag);
                question.addEventListener('touchstart', startDrag, { passive: false });
            });

            abstractions.forEach(abstraction => {
                abstraction.addEventListener('mousedown', startDrag);
                abstraction.addEventListener('touchstart', startDrag, { passive: false });
            });

            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('touchend', endDrag);

            [...rootSlots, ...trunkSlots].forEach(slot => {
                slot.addEventListener('mouseenter', highlightSlot);
                slot.addEventListener('mouseleave', unhighlightSlot);
            });
        }

        function startDrag(e) {
            e.preventDefault();
            
            if (e.target.classList.contains('placed') || 
                e.target.classList.contains('disabled') || 
                e.target.classList.contains('unavailable')) return;
            
            isDragging = true;
            currentDragElement = e.target;
            
            // Criar fantasma visual
            dragGhost = createDragGhost(currentDragElement);
            
            // Marcar elemento original como sendo arrastado
            currentDragElement.classList.add('dragging');
            
            const rect = currentDragElement.getBoundingClientRect();
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            
            offset.x = clientX - rect.left;
            offset.y = clientY - rect.top;
            
            updateDragPosition(clientX, clientY);
        }

        function drag(e) {
            if (!isDragging || !dragGhost) return;
            
            e.preventDefault();
            
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            
            updateDragPosition(clientX, clientY);
        }

        function updateDragPosition(clientX, clientY) {
            if (!dragGhost) return;
            
            dragGhost.style.left = (clientX - offset.x) + 'px';
            dragGhost.style.top = (clientY - offset.y) + 'px';
        }

        function endDrag(e) {
            if (!isDragging || !currentDragElement) return;
            
            const clientX = e.type.includes('touch') ? e.changedTouches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.changedTouches[0].clientY : e.clientY;
            
            const isQuestion = currentDragElement.classList.contains('question-bubble');
            const validSlots = isQuestion ? 
                document.querySelectorAll('.root-slot') : 
                document.querySelectorAll('.trunk-slot:not(.disabled):not(.unavailable)');
            
            let targetSlot = null;
            
            validSlots.forEach(slot => {
                const slotRect = slot.getBoundingClientRect();
                if (clientX >= slotRect.left && clientX <= slotRect.right &&
                    clientY >= slotRect.top && clientY <= slotRect.bottom &&
                    !slot.classList.contains('filled')) {
                    
                    if (!isQuestion) {
                        const slotAbstraction = slot.dataset.abstraction;
                        const dragAbstraction = currentDragElement.dataset.abstraction;
                        if (slotAbstraction === dragAbstraction) {
                            targetSlot = slot;
                        }
                    } else {
                        targetSlot = slot;
                    }
                }
            });
            
            if (targetSlot) {
                if (isQuestion) {
                    placeQuestionInSlot(currentDragElement, targetSlot);
                } else {
                    placeAbstractionInSlot(currentDragElement, targetSlot);
                }
            }
            
            // Limpar drag
            currentDragElement.classList.remove('dragging');
            if (dragGhost) {
                document.body.removeChild(dragGhost);
                dragGhost = null;
            }
            
            validSlots.forEach(slot => slot.classList.remove('highlight'));
            
            isDragging = false;
            currentDragElement = null;
        }

        function placeQuestionInSlot(question, slot) {
            slot.classList.add('filled');
            slot.textContent = question.textContent;
            slot.style.fontSize = '14px';
            
            question.classList.add('placed');
            handleRootQuestionPlacement();
        }

        function placeAbstractionInSlot(abstraction, slot) {
            const abstractionType = abstraction.dataset.abstraction;
            
            slot.classList.add('filled');
            slot.textContent = abstraction.textContent;
            slot.style.fontSize = '14px';
            
            abstraction.classList.add('placed');
            handleTrunkAbstractionPlacement(abstractionType);
        }

        function highlightSlot(e) {
            if (isDragging && !e.target.classList.contains('filled') && 
                !e.target.classList.contains('disabled') && 
                !e.target.classList.contains('unavailable')) {
                
                const isQuestion = currentDragElement?.classList.contains('question-bubble');
                const isRootSlot = e.target.classList.contains('root-slot');
                const isTrunkSlot = e.target.classList.contains('trunk-slot');
                
                if ((isQuestion && isRootSlot) || 
                    (!isQuestion && isTrunkSlot && 
                     e.target.dataset.abstraction === currentDragElement?.dataset.abstraction)) {
                    e.target.classList.add('highlight');
                }
            }
        }

        function unhighlightSlot(e) {
            e.target.classList.remove('highlight');
        }

        function cutRoots() {
            if (currentStage < 3) return;
            
            isWithering = !isWithering;
            const toggle = document.getElementById('seasonToggle');
            const mainContainer = document.querySelector('.main-container');
            
            if (isWithering) {
                toggle.textContent = '🌱 Fazer Crescer';
                toggle.classList.add('cutting');
                mainContainer.classList.add('withering');
                
                document.querySelectorAll('.root-path').forEach((root, i) => {
                    setTimeout(() => {
                        root.classList.add('withering');
                    }, i * 100);
                });
                
                document.querySelectorAll('.leaf-topic').forEach((el, i) => {
                    setTimeout(() => el.classList.remove('visible'), i * 8);
                });
                document.querySelectorAll('.leaves-group ellipse').forEach((el, i) => {
                    setTimeout(() => el.classList.add('withering'), i * 8);
                });
            } else {
                toggle.textContent = '✂️ Cortar Raízes';
                toggle.classList.remove('cutting');
                mainContainer.classList.remove('withering');
                
                document.querySelectorAll('.root-path').forEach((root, i) => {
                    setTimeout(() => {
                        root.classList.remove('withering');
                    }, i * 100);
                });
                
                document.querySelectorAll('.leaf-topic').forEach((el, i) => {
                    setTimeout(() => el.classList.add('visible'), i * 8);
                });
                document.querySelectorAll('.leaves-group ellipse').forEach((el, i) => {
                    setTimeout(() => el.classList.remove('withering'), i * 8);
                });
            }
        }

        // Inicialização
        window.addEventListener('load', () => {
            initializeDragAndDrop();
            
            // Adicionar event listeners para os tópicos
            const topicElements = document.querySelectorAll('.leaf-topic');
            topicElements.forEach((topicEl, index) => {
                if (topics[index]) {
                    topicEl.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (currentStage >= 2) {
                            navigateToChapter(topics[index]);
                        }
                    });
                }
            });
            
            setTimeout(() => {
                document.body.style.opacity = '1';
            }, 100);
        });

        document.addEventListener('dragstart', (e) => {
            e.preventDefault();
        });

        document.body.style.opacity = '0';
        document.body.style.transition = 'opacity 0.5s ease';
    </script>
</body>
</html>
