<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Árvore das Abstrações Matemáticas</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Georgia', serif;
            background: linear-gradient(to bottom, #1a2b4c 0%, #2c4a78 30%, #4a6741 70%, #2d3b2d 100%);
            color: #ffffff;
            overflow: hidden;
            height: 100vh;
        }

        .book-cover {
            max-width: 100%;
            margin: 0;
            padding: 10px;
            position: relative;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            max-width: 320px;
        }

        .title {
            font-size: 2.2rem;
            font-weight: bold;
            background: linear-gradient(45deg, #4fc3f7, #81c784, #ffb74d);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
            text-shadow: 0 0 30px rgba(79, 195, 247, 0.3);
        }

        .subtitle {
            font-size: 1.2rem;
            color: #e0e0e0;
            font-style: italic;
            margin-bottom: 10px;
        }

        .instructions {
            font-size: 0.85rem;
            color: #b0bec5;
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(79, 195, 247, 0.3);
            line-height: 1.4;
        }

        .tree-container {
            position: relative;
            width: 100%;
            height: 100vh;
            margin: 0 auto;
            flex-grow: 1;
        }

        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 200;
        }

        .season-toggle {
            background: linear-gradient(45deg, #f44336, #e57373);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            opacity: 0.3;
            pointer-events: none;
        }

        .season-toggle.active {
            opacity: 1;
            pointer-events: all;
        }

        .season-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
        }

        .season-toggle.cutting {
            background: linear-gradient(45deg, #795548, #8d6e63);
        }

        /* Raízes e Tronco SVG */
        .roots-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        .root-path, .trunk-svg, .trunk-line, .branch-path {
            transition: all 0.8s ease;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .root-path.withering {
            stroke: #8d6e63;
            opacity: 0.6;
            filter: drop-shadow(0 0 5px rgba(139, 69, 19, 0.5));
            animation: wither 2s ease-in-out;
        }

        @keyframes wither {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.3; transform: scale(0.95); }
            100% { opacity: 0.6; transform: scale(0.9); }
        }

        /* Slots do Tronco - Segmentos delimitados */
        .trunk-slot {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 140px;
            height: 50px;
            border: 2px dashed rgba(255, 193, 7, 0.6);
            border-radius: 4px;
            background: transparent;
            z-index: 40;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            cursor: pointer;
        }

        .trunk-slot.disabled {
            opacity: 0.3;
            border-color: rgba(255, 193, 7, 0.2);
            color: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
        }

        .trunk-slot.highlight {
            border-color: rgba(255, 193, 7, 1);
            background: rgba(255, 193, 7, 0.1);
            transform: translateX(-50%) scale(1.02);
        }

        .trunk-slot.filled {
            background: transparent;
            border-color: rgba(255, 193, 7, 0.9);
            border-style: solid;
            color: #ffffff;
            font-weight: bold;
            font-size: 11px;
        }

        .trunk-slot.unavailable {
            opacity: 0.5;
            border-color: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.4);
            cursor: not-allowed;
        }

        /* Posicionamento dos slots do tronco */
        .trunk-slot.intuition-slot { bottom: 380px; }
        .trunk-slot.geometry-slot { bottom: 530px; }
        .trunk-slot.analysis-slot { bottom: 680px; }
        .trunk-slot.topology-slot { bottom: 830px; }

        /* Delimitadores visuais do tronco */
        .trunk-delimiter {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            z-index: 35;
        }

        .trunk-delimiter.d1 { bottom: 360px; }
        .trunk-delimiter.d2 { bottom: 510px; }
        .trunk-delimiter.d3 { bottom: 660px; }
        .trunk-delimiter.d4 { bottom: 810px; }

        /* Folhas SVG */
        .leaves-group ellipse {
            transition: all 1s ease;
            transform-origin: center;
            opacity: 0;
        }

        .leaves-group ellipse.visible {
            opacity: 1;
            transform: scale(1);
        }

        .leaves-group ellipse.withering {
            opacity: 0.4;
            transform: scale(0.8) translateY(20px);
            filter: sepia(0.8) hue-rotate(30deg);
        }

        /* Perguntas e Nomes das Abstrações Arrastáveis */
        .draggable-questions, .draggable-abstractions {
            position: absolute;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }

        .draggable-questions {
            bottom: 300px;
        }

        .draggable-abstractions {
            bottom: 420px;
        }

        .question-bubble, .abstraction-bubble {
            background: transparent;
            color: #ffffff;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            cursor: grab;
            transition: all 0.2s ease;
            font-family: 'Georgia', serif;
            text-align: left;
            user-select: none;
            position: relative;
            touch-action: none;
            min-width: 140px;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .question-bubble {
            border-color: rgba(79, 195, 247, 0.7);
        }

        .abstraction-bubble {
            border-color: rgba(255, 193, 7, 0.7);
        }

        .abstraction-bubble.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            border-color: rgba(255, 193, 7, 0.3);
            color: rgba(255, 255, 255, 0.4);
        }

        .abstraction-bubble.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.4);
        }

        .question-bubble:hover, .abstraction-bubble:hover {
            background: rgba(0, 0, 0, 0.2);
            transform: translateX(2px);
        }

        .abstraction-bubble.disabled:hover, .abstraction-bubble.unavailable:hover {
            background: transparent;
            transform: none;
        }

        .question-bubble:active, .abstraction-bubble:active {
            cursor: grabbing;
        }

        .question-bubble.dragging, .abstraction-bubble.dragging {
            cursor: grabbing !important;
            z-index: 1000 !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
            transition: none !important;
            background: rgba(0, 0, 0, 0.3) !important;
        }

        .question-bubble.placed, .abstraction-bubble.placed {
            opacity: 0.4;
            pointer-events: none;
        }

        /* Slots das Raízes */
        .root-slot {
            position: absolute;
            width: 80px;
            height: 40px;
            border: 2px dashed rgba(79, 195, 247, 0.6);
            border-radius: 4px;
            background: transparent;
            z-index: 50;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
        }

        .root-slot.highlight {
            border-color: rgba(79, 195, 247, 1);
            background: rgba(79, 195, 247, 0.1);
            transform: scale(1.02);
        }

        .root-slot.filled {
            background: transparent;
            border-color: rgba(79, 195, 247, 0.9);
            border-style: solid;
            color: #ffffff;
            font-weight: bold;
        }

        /* Tópicos nas Folhas - Melhor posicionamento */
        .leaf-topic {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: #ffffff;
            padding: 6px 10px;
            border-radius: 12px;
            font-size: 9px;
            font-weight: bold;
            transition: all 0.5s ease;
            border: 1px solid rgba(255, 255, 255, 0.4);
            opacity: 0;
            z-index: 20;
            transform: translateX(-50%) scale(0.5);
            cursor: pointer;
            text-decoration: none;
            display: block;
            min-width: 120px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .leaf-topic.visible {
            opacity: 1;
            transform: translateX(-50%) scale(1);
        }

        .leaf-topic:hover {
            background: rgba(79, 195, 247, 0.9);
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 4px 12px rgba(79, 195, 247, 0.4);
            border-color: rgba(255, 255, 255, 0.8);
        }

        /* Animação de transição para capítulos */
        .chapter-transition {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at center, 
                rgba(79, 195, 247, 0.9) 0%, 
                rgba(79, 195, 247, 0.7) 30%, 
                rgba(26, 43, 76, 0.95) 70%, 
                rgba(0, 0, 0, 1) 100%);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transition: all 0.8s ease;
        }

        .chapter-transition.active {
            opacity: 1;
            pointer-events: all;
        }

        .transition-content {
            text-align: center;
            color: white;
            transform: translateY(30px);
            transition: all 0.8s ease 0.2s;
        }

        .chapter-transition.active .transition-content {
            transform: translateY(0);
        }

        .transition-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        .transition-subtitle {
            font-size: 1.2rem;
            opacity: 0.8;
            margin-bottom: 30px;
        }

        .loading-animation {
            width: 80px;
            height: 80px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Efeito de murcha global */
        .withering .root-path, .withering .branch-path {
            stroke: #8d6e63;
            filter: drop-shadow(0 0 3px rgba(139, 69, 19, 0.5));
        }

        .withering .trunk-svg {
            fill: #8d6e63;
        }
        .withering .trunk-line {
             stroke: #6d4c41;
        }

        .withering .question-bubble, .withering .abstraction-bubble {
            opacity: 0.7;
            border-color: rgba(139, 69, 19, 0.4);
        }

        /* Tooltip para tópicos */
        .leaf-topic::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-5px);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 5px 8px;
            border-radius: 6px;
            font-size: 8px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .leaf-topic:hover::after {
            opacity: 1;
            transform: translateX(-50%) translateY(-10px);
        }

        @media (max-width: 768px) {
            .title { font-size: 1.5rem; }
            .subtitle { font-size: 0.9rem; }
            .instructions { font-size: 0.8rem; }
            .question-bubble, .abstraction-bubble { font-size: 10px; padding: 8px 12px; }
            .leaf-topic { font-size: 8px; padding: 4px 8px; min-width: 100px; }
            .draggable-questions, .draggable-abstractions { flex-direction: column; gap: 8px; }
            .transition-title { font-size: 2rem; }
            .transition-subtitle { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <div class="book-cover">
        <div class="header">
            <h1 class="title">Formas Diferenciais, Topologia e Física</h1>
            <p class="subtitle">Um Resgate Interativo à Intuição</p>
        </div>

        <div class="controls">
            <button class="season-toggle" id="seasonToggle" onclick="cutRoots()">
                ✂️ Cortar Raízes
            </button>
        </div>

        <div class="tree-container" id="treeContainer">
            <!-- Delimitadores do Tronco -->
            <div class="trunk-delimiter d1"></div>
            <div class="trunk-delimiter d2"></div>
            <div class="trunk-delimiter d3"></div>
            <div class="trunk-delimiter d4"></div>

            <!-- Slots do Tronco (Camadas de Abstração) - Ordem obrigatória -->
            <div class="trunk-slot intuition-slot disabled" id="trunkSlot1" data-order="1" data-abstraction="intuition">
                Complete as raízes primeiro
            </div>
            <div class="trunk-slot geometry-slot unavailable" id="trunkSlot2" data-order="2" data-abstraction="geometry">
                Coloque "Intuição" primeiro
            </div>
            <div class="trunk-slot analysis-slot unavailable" id="trunkSlot3" data-order="3" data-abstraction="analysis">
                Coloque "Geometria/Física" primeiro
            </div>
            <div class="trunk-slot topology-slot unavailable" id="trunkSlot4" data-order="4" data-abstraction="topology">
                Coloque "Analogias" primeiro
            </div>

            <!-- Slots das Raízes -->
            <div class="root-slot" id="slot1" style="bottom: 50px; left: calc(50% - 200px);">
                Arraste aqui
            </div>
            <div class="root-slot" id="slot2" style="bottom: 50px; left: calc(50% - 40px);">
                Arraste aqui
            </div>
            <div class="root-slot" id="slot3" style="bottom: 50px; left: calc(50% + 120px);">
                Arraste aqui
            </div>

            <svg class="roots-svg" viewBox="0 0 2000 1200" preserveAspectRatio="xMidYMax meet">
                <rect x="-1000" y="900" width="50000" height="300" fill="#8d6e63" opacity="0.8"/>
                
                <!-- Raízes mais detalhadas -->
                <path class="root-path" d="M1000 900 C 985 920, 975 950, 970 980 C 965 1010, 960 1040, 955 1070 C 950 1100, 945 1130, 940 1160 C 935 1180, 930 1195, 925 1200" stroke="#5d4037" stroke-width="6" fill="none" stroke-linecap="round"/>
                <path class="root-path" d="M1000 900 C 1015 920, 1025 950, 1030 980 C 1035 1010, 1040 1040, 1045 1070 C 1050 1100, 1055 1130, 1060 1160 C 1065 1180, 1070 1195, 1075 1200" stroke="#5d4037" stroke-width="6" fill="none" stroke-linecap="round"/>
                <path class="root-path" d="M1000 900 C 950 920, 900 945, 850 975 C 820 995, 790 1020, 760 1050 C 730 1080, 700 1110, 670 1140 C 650 1160, 630 1180, 610 1200" stroke="#4e342e" stroke-width="4" fill="none" stroke-linecap="round"/>
                <path class="root-path" d="M1000 900 C 1050 920, 1100 945, 1150 975 C 1180 995, 1210 1020, 1240 1050 C 1270 1080, 1300 1110, 1330 1140 C 1350 1160, 1370 1180, 1390 1200" stroke="#4e342e" stroke-width="4" fill="none" stroke-linecap="round"/>
                <path class="root-path" d="M850 975 C 830 990, 810 1010, 795 1035 C 780 1060, 765 1085, 750 1110 C 735 1135, 720 1160, 705 1185 C 695 1192, 685 1196, 675 1200" stroke="#3e2723" stroke-width="3" fill="none" stroke-linecap="round"/>
                <path class="root-path" d="M1150 975 C 1170 990, 1190 1010, 1205 1035 C 1220 1060, 1235 1085, 1250 1110 C 1265 1135, 1280 1160, 1295 1185 C 1305 1192, 1315 1196, 1325 1200" stroke="#3e2723" stroke-width="3" fill="none" stroke-linecap="round"/>
                
                <!-- Tronco principal com segmentação visual -->
                <path class="trunk-svg" d="M960 900 Q 950 700 950 500 T 960 100 L 1040 100 Q 1050 500 1050 700 T 1040 900 Z" fill="#8d6e63"/>
                <line class="trunk-line" x1="1000" y1="120" x2="1000" y2="880" stroke="#6d4c41" stroke-width="8" />
                
                <!-- Linhas de segmentação do tronco -->
                <line class="trunk-line" x1="960" y1="220" x2="1040" y2="220" stroke="#6d4c41" stroke-width="4" opacity="0.7" />
                <line class="trunk-line" x1="960" y1="370" x2="1040" y2="370" stroke="#6d4c41" stroke-width="4" opacity="0.7" />
                <line class="trunk-line" x1="960" y1="520" x2="1040" y2="520" stroke="#6d4c41" stroke-width="4" opacity="0.7" />
                <line class="trunk-line" x1="960" y1="670" x2="1040" y2="670" stroke="#6d4c41" stroke-width="4" opacity="0.7" />
                
                <!-- Texturas do tronco -->
                <path class="trunk-line" d="M970 200 C 1000 210, 1030 190, 1030 200" stroke="#6d4c41" stroke-width="6" fill="none" />
                <path class="trunk-line" d="M970 500 C 1000 510, 1030 490, 1030 500" stroke="#6d4c41" stroke-width="6" fill="none" />
                <path class="trunk-line" d="M970 800 C 1000 810, 1030 790, 1030 800" stroke="#6d4c41" stroke-width="6" fill="none" />
                
                <g class="branches-group">
                    <path class="branch-path" d="M1000 450 C 975 400, 825 280, 725 150" stroke="#6d4c41" stroke-width="35" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M1000 450 C 1025 400, 1175 280, 1275 150" stroke="#6d4c41" stroke-width="35" fill="none" stroke-linecap="round"/>
                    
                    <path class="branch-path" d="M1000 300 C 925 250, 850 180, 790 120" stroke="#6d4c41" stroke-width="28" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M1000 300 C 1075 250, 1150 180, 1210 120" stroke="#6d4c41" stroke-width="28" fill="none" stroke-linecap="round"/>
                    
                    <path class="branch-path" d="M1000 200 C 963 150, 888 80, 838 50" stroke="#6d4c41" stroke-width="25" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M1000 200 C 1037 150, 1112 80, 1162 50" stroke="#6d4c41" stroke-width="25" fill="none" stroke-linecap="round"/>
                    
                    <path class="branch-path" d="M825 280 C 775 230, 705 170, 645 140" stroke="#6d4c41" stroke-width="18" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M790 120 C 755 90, 715 50, 685 30" stroke="#6d4c41" stroke-width="18" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M975 400 C 925 350, 848 280, 805 240" stroke="#6d4c41" stroke-width="20" fill="none" stroke-linecap="round"/>
                    
                    <path class="branch-path" d="M1175 280 C 1225 230, 1295 170, 1355 140" stroke="#6d4c41" stroke-width="18" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M1210 120 C 1245 90, 1285 50, 1315 30" stroke="#6d4c41" stroke-width="18" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M1025 400 C 1075 350, 1152 280, 1195 240" stroke="#6d4c41" stroke-width="20" fill="none" stroke-linecap="round"/>
                    
                    <path class="branch-path" d="M725 150 C 675 120, 610 80, 565 60" stroke="#6d4c41" stroke-width="15" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M1275 150 C 1325 120, 1390 80, 1435 60" stroke="#6d4c41" stroke-width="15" fill="none" stroke-linecap="round"/>
                    
                    <path class="branch-path" d="M645 140 C 615 110, 575 70, 545 50" stroke="#6d4c41" stroke-width="12" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M1355 140 C 1385 110, 1425 70, 1455 50" stroke="#6d4c41" stroke-width="12" fill="none" stroke-linecap="round"/>
                    
                    <path class="branch-path" d="M838 50 C 815 30, 785 10, 763 5" stroke="#6d4c41" stroke-width="10" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M1162 50 C 1185 30, 1215 10, 1237 5" stroke="#6d4c41" stroke-width="10" fill="none" stroke-linecap="round"/>
                    
                    <path class="branch-path" d="M805 240 C 765 200, 718 150, 685 120" stroke="#6d4c41" stroke-width="14" fill="none" stroke-linecap="round"/>
                    <path class="branch-path" d="M1195 240 C 1235 200, 1282 150, 1315 120" stroke="#6d4c41" stroke-width="14" fill="none" stroke-linecap="round"/>
                </g>

                <g class="leaves-group" id="leavesGroup">
                    <!-- GALHO PRINCIPAL ESQUERDO: M1000 450 C 975 400, 825 280, 725 150 -->
                    <ellipse cx="975" cy="425" rx="50" ry="35" fill="#4caf50"/>
                    <ellipse cx="950" cy="390" rx="45" ry="30" fill="#66bb6a"/>
                    <ellipse cx="900" cy="340" rx="48" ry="32" fill="#4caf50"/>
                    <ellipse cx="875" cy="310" rx="42" ry="28" fill="#81c784"/>
                    <ellipse cx="825" cy="280" rx="50" ry="35" fill="#4caf50"/>
                    <ellipse cx="800" cy="250" rx="45" ry="30" fill="#66bb6a"/>
                    <ellipse cx="775" cy="220" rx="48" ry="32" fill="#a5d6a7"/>
                    <ellipse cx="750" cy="185" rx="42" ry="28" fill="#4caf50"/>
                    <ellipse cx="725" cy="150" rx="50" ry="35" fill="#66bb6a"/>

                    <!-- GALHO PRINCIPAL DIREITO: M1000 450 C 1025 400, 1175 280, 1275 150 -->
                    <ellipse cx="1025" cy="425" rx="50" ry="35" fill="#4caf50"/>
                    <ellipse cx="1050" cy="390" rx="45" ry="30" fill="#66bb6a"/>
                    <ellipse cx="1100" cy="340" rx="48" ry="32" fill="#4caf50"/>
                    <ellipse cx="1125" cy="310" rx="42" ry="28" fill="#81c784"/>
                    <ellipse cx="1175" cy="280" rx="50" ry="35" fill="#4caf50"/>
                    <ellipse cx="1200" cy="250" rx="45" ry="30" fill="#66bb6a"/>
                    <ellipse cx="1225" cy="220" rx="48" ry="32" fill="#a5d6a7"/>
                    <ellipse cx="1250" cy="185" rx="42" ry="28" fill="#4caf50"/>
                    <ellipse cx="1275" cy="150" rx="50" ry="35" fill="#66bb6a"/>

                    <!-- GALHO MÉDIO ESQUERDO: M1000 300 C 925 250, 850 180, 790 120 -->
                    <ellipse cx="925" cy="275" rx="45" ry="30" fill="#66bb6a"/>
                    <ellipse cx="900" cy="240" rx="48" ry="32" fill="#4caf50"/>
                    <ellipse cx="875" cy="210" rx="42" ry="28" fill="#81c784"/>
                    <ellipse cx="850" cy="180" rx="50" ry="35" fill="#a5d6a7"/>
                    <ellipse cx="820" cy="150" rx="45" ry="30" fill="#4caf50"/>
                    <ellipse cx="790" cy="120" rx="48" ry="32" fill="#66bb6a"/>

                    <!-- GALHO MÉDIO DIREITO: M1000 300 C 1075 250, 1150 180, 1210 120 -->
                    <ellipse cx="1075" cy="275" rx="45" ry="30" fill="#66bb6a"/>
                    <ellipse cx="1100" cy="240" rx="48" ry="32" fill="#4caf50"/>
                    <ellipse cx="1125" cy="210" rx="42" ry="28" fill="#81c784"/>
                    <ellipse cx="1150" cy="180" rx="50" ry="35" fill="#a5d6a7"/>
                    <ellipse cx="1180" cy="150" rx="45" ry="30" fill="#4caf50"/>
                    <ellipse cx="1210" cy="120" rx="48" ry="32" fill="#66bb6a"/>

                    <!-- GALHO SUPERIOR ESQUERDO: M1000 200 C 963 150, 888 80, 838 50 -->
                    <ellipse cx="963" cy="175" rx="40" ry="28" fill="#4caf50"/>
                    <ellipse cx="930" cy="125" rx="42" ry="30" fill="#66bb6a"/>
                    <ellipse cx="900" cy="95" rx="38" ry="26" fill="#81c784"/>
                    <ellipse cx="870" cy="70" rx="45" ry="32" fill="#a5d6a7"/>
                    <ellipse cx="838" cy="50" rx="40" ry="28" fill="#4caf50"/>

                    <!-- GALHO SUPERIOR DIREITO: M1000 200 C 1037 150, 1112 80, 1162 50 -->
                    <ellipse cx="1037" cy="175" rx="40" ry="28" fill="#4caf50"/>
                    <ellipse cx="1070" cy="125" rx="42" ry="30" fill="#66bb6a"/>
                    <ellipse cx="1100" cy="95" rx="38" ry="26" fill="#81c784"/>
                    <ellipse cx="1130" cy="70" rx="45" ry="32" fill="#a5d6a7"/>
                    <ellipse cx="1162" cy="50" rx="40" ry="28" fill="#4caf50"/>

                    <!-- RAMIFICAÇÃO: M825 280 C 775 230, 705 170, 645 140 -->
                    <ellipse cx="775" cy="255" rx="38" ry="26" fill="#66bb6a"/>
                    <ellipse cx="740" cy="200" rx="40" ry="28" fill="#4caf50"/>
                    <ellipse cx="720" cy="175" rx="35" ry="24" fill="#81c784"/>
                    <ellipse cx="685" cy="155" rx="42" ry="30" fill="#a5d6a7"/>
                    <ellipse cx="645" cy="140" rx="38" ry="26" fill="#66bb6a"/>

                    <!-- RAMIFICAÇÃO: M1175 280 C 1225 230, 1295 170, 1355 140 -->
                    <ellipse cx="1225" cy="255" rx="38" ry="26" fill="#66bb6a"/>
                    <ellipse cx="1260" cy="200" rx="40" ry="28" fill="#4caf50"/>
                    <ellipse cx="1280" cy="175" rx="35" ry="24" fill="#81c784"/>
                    <ellipse cx="1315" cy="155" rx="42" ry="30" fill="#a5d6a7"/>
                    <ellipse cx="1355" cy="140" rx="38" ry="26" fill="#66bb6a"/>

                    <!-- RAMIFICAÇÃO: M790 120 C 755 90, 715 50, 685 30 -->
                    <ellipse cx="755" cy="105" rx="35" ry="24" fill="#a5d6a7"/>
                    <ellipse cx="735" cy="70" rx="38" ry="26" fill="#66bb6a"/>
                    <ellipse cx="700" cy="40" rx="40" ry="28" fill="#4caf50"/>
                    <ellipse cx="685" cy="30" rx="35" ry="24" fill="#81c784"/>

                    <!-- RAMIFICAÇÃO: M1210 120 C 1245 90, 1285 50, 1315 30 -->
                    <ellipse cx="1245" cy="105" rx="35" ry="24" fill="#a5d6a7"/>
                    <ellipse cx="1265" cy="70" rx="38" ry="26" fill="#66bb6a"/>
                    <ellipse cx="1300" cy="40" rx="40" ry="28" fill="#4caf50"/>
                    <ellipse cx="1315" cy="30" rx="35" ry="24" fill="#81c784"/>

                    <!-- RAMIFICAÇÃO: M975 400 C 925 350, 848 280, 805 240 -->
                    <ellipse cx="925" cy="375" rx="42" ry="30" fill="#4caf50"/>
                    <ellipse cx="890" cy="325" rx="40" ry="28" fill="#66bb6a"/>
                    <ellipse cx="870" cy="300" rx="38" ry="26" fill="#81c784"/>
                    <ellipse cx="830" cy="260" rx="45" ry="32" fill="#a5d6a7"/>
                    <ellipse cx="805" cy="240" rx="42" ry="30" fill="#4caf50"/>

                    <!-- RAMIFICAÇÃO: M1025 400 C 1075 350, 1152 280, 1195 240 -->
                    <ellipse cx="1075" cy="375" rx="42" ry="30" fill="#4caf50"/>
                    <ellipse cx="1110" cy="325" rx="40" ry="28" fill="#66bb6a"/>
                    <ellipse cx="1130" cy="300" rx="38" ry="26" fill="#81c784"/>
                    <ellipse cx="1170" cy="260" rx="45" ry="32" fill="#a5d6a7"/>
                    <ellipse cx="1195" cy="240" rx="42" ry="30" fill="#4caf50"/>

                    <!-- OUTRAS RAMIFICAÇÕES MENORES -->
                    <!-- M725 150 C 675 120, 610 80, 565 60 -->
                    <ellipse cx="675" cy="135" rx="35" ry="24" fill="#a5d6a7"/>
                    <ellipse cx="640" cy="100" rx="38" ry="26" fill="#66bb6a"/>
                    <ellipse cx="590" cy="70" rx="40" ry="28" fill="#4caf50"/>
                    <ellipse cx="565" cy="60" rx="35" ry="24" fill="#81c784"/>

                    <!-- M1275 150 C 1325 120, 1390 80, 1435 60 -->
                    <ellipse cx="1325" cy="135" rx="35" ry="24" fill="#a5d6a7"/>
                    <ellipse cx="1360" cy="100" rx="38" ry="26" fill="#66bb6a"/>
                    <ellipse cx="1410" cy="70" rx="40" ry="28" fill="#4caf50"/>
                    <ellipse cx="1435" cy="60" rx="35" ry="24" fill="#81c784"/>

                    <!-- M645 140 C 615 110, 575 70, 545 50 -->
                    <ellipse cx="615" cy="125" rx="32" ry="22" fill="#66bb6a"/>
                    <ellipse cx="595" cy="90" rx="35" ry="24" fill="#4caf50"/>
                    <ellipse cx="560" cy="60" rx="38" ry="26" fill="#81c784"/>
                    <ellipse cx="545" cy="50" rx="32" ry="22" fill="#a5d6a7"/>

                    <!-- M1355 140 C 1385 110, 1425 70, 1455 50 -->
                    <ellipse cx="1385" cy="125" rx="32" ry="22" fill="#66bb6a"/>
                    <ellipse cx="1405" cy="90" rx="35" ry="24" fill="#4caf50"/>
                    <ellipse cx="1440" cy="60" rx="38" ry="26" fill="#81c784"/>
                    <ellipse cx="1455" cy="50" rx="32" ry="22" fill="#a5d6a7"/>

                    <!-- M838 50 C 815 30, 785 10, 763 5 -->
                    <ellipse cx="815" cy="40" rx="30" ry="20" fill="#a5d6a7"/>
                    <ellipse cx="800" cy="20" rx="32" ry="22" fill="#66bb6a"/>
                    <ellipse cx="775" cy="8" rx="35" ry="24" fill="#4caf50"/>
                    <ellipse cx="763" cy="5" rx="30" ry="20" fill="#81c784"/>

                    <!-- M1162 50 C 1185 30, 1215 10, 1237 5 -->
                    <ellipse cx="1185" cy="40" rx="30" ry="20" fill="#a5d6a7"/>
                    <ellipse cx="1200" cy="20" rx="32" ry="22" fill="#66bb6a"/>
                    <ellipse cx="1225" cy="8" rx="35" ry="24" fill="#4caf50"/>
                    <ellipse cx="1237" cy="5" rx="30" ry="20" fill="#81c784"/>

                    <!-- M805 240 C 765 200, 718 150, 685 120 -->
                    <ellipse cx="765" cy="220" rx="35" ry="24" fill="#4caf50"/>
                    <ellipse cx="740" cy="175" rx="38" ry="26" fill="#66bb6a"/>
                    <ellipse cx="700" cy="135" rx="40" ry="28" fill="#81c784"/>
                    <ellipse cx="685" cy="120" rx="35" ry="24" fill="#a5d6a7"/>

                    <!-- M1195 240 C 1235 200, 1282 150, 1315 120 -->
                    <ellipse cx="1235" cy="220" rx="35" ry="24" fill="#4caf50"/>
                    <ellipse cx="1260" cy="175" rx="38" ry="26" fill="#66bb6a"/>
                    <ellipse cx="1300" cy="135" rx="40" ry="28" fill="#81c784"/>
                    <ellipse cx="1315" cy="120" rx="35" ry="24" fill="#a5d6a7"/>

                    <!-- Preenchimento adicional para árvore densa -->
                    <ellipse cx="990" cy="430" rx="45" ry="32" fill="#4caf50"/>
                    <ellipse cx="1010" cy="420" rx="42" ry="30" fill="#66bb6a"/>
                    <ellipse cx="985" cy="400" rx="48" ry="35" fill="#81c784"/>
                    <ellipse cx="1015" cy="390" rx="40" ry="28" fill="#4caf50"/>
                    <ellipse cx="995" cy="370" rx="45" ry="32" fill="#a5d6a7"/>
                    <ellipse cx="1005" cy="350" rx="42" ry="30" fill="#66bb6a"/>
                    <ellipse cx="990" cy="330" rx="48" ry="35" fill="#4caf50"/>
                    <ellipse cx="1010" cy="320" rx="40" ry="28" fill="#81c784"/>
                    <ellipse cx="985" cy="290" rx="45" ry="32" fill="#a5d6a7"/>
                    <ellipse cx="1015" cy="280" rx="42" ry="30" fill="#66bb6a"/>
                    <ellipse cx="995" cy="260" rx="48" ry="35" fill="#4caf50"/>
                    <ellipse cx="1005" cy="240" rx="40" ry="28" fill="#81c784"/>
                    <ellipse cx="990" cy="220" rx="45" ry="32" fill="#a5d6a7"/>
                    <ellipse cx="1010" cy="210" rx="42" ry="30" fill="#66bb6a"/>

                    <!-- Mais folhas para completar espaços -->
                    <ellipse cx="970" cy="360" rx="40" ry="28" fill="#66bb6a"/>
                    <ellipse cx="1030" cy="360" rx="38" ry="26" fill="#4caf50"/>
                    <ellipse cx="950" cy="320" rx="42" ry="30" fill="#81c784"/>
                    <ellipse cx="1050" cy="320" rx="40" ry="28" fill="#a5d6a7"/>
                    <ellipse cx="980" cy="280" rx="45" ry="32" fill="#4caf50"/>
                    <ellipse cx="1020" cy="280" rx="42" ry="30" fill="#66bb6a"/>
                    <ellipse cx="960" cy="250" rx="38" ry="26" fill="#81c784"/>
                    <ellipse cx="1040" cy="250" rx="40" ry="28" fill="#a5d6a7"/>
                    <ellipse cx="975" cy="230" rx="42" ry="30" fill="#4caf50"/>
                    <ellipse cx="1025" cy="230" rx="38" ry="26" fill="#66bb6a"/>

                    <!-- Folhas adicionais nas extremidades -->
                    <ellipse cx="850" cy="200" rx="35" ry="24" fill="#a5d6a7"/>
                    <ellipse cx="820" cy="180" rx="38" ry="26" fill="#66bb6a"/>
                    <ellipse cx="880" cy="160" rx="40" ry="28" fill="#4caf50"/>
                    <ellipse cx="860" cy="140" rx="35" ry="24" fill="#81c784"/>
                    <ellipse cx="890" cy="120" rx="38" ry="26" fill="#a5d6a7"/>
                    <ellipse cx="870" cy="100" rx="40" ry="28" fill="#66bb6a"/>
                    <ellipse cx="850" cy="80" rx="35" ry="24" fill="#4caf50"/>
                    <ellipse cx="880" cy="60" rx="38" ry="26" fill="#81c784"/>

                    <ellipse cx="1150" cy="200" rx="35" ry="24" fill="#a5d6a7"/>
                    <ellipse cx="1180" cy="180" rx="38" ry="26" fill="#66bb6a"/>
                    <ellipse cx="1120" cy="160" rx="40" ry="28" fill="#4caf50"/>
                    <ellipse cx="1140" cy="140" rx="35" ry="24" fill="#81c784"/>
                    <ellipse cx="1110" cy="120" rx="38" ry="26" fill="#a5d6a7"/>
                    <ellipse cx="1130" cy="100" rx="40" ry="28" fill="#66bb6a"/>
                    <ellipse cx="1150" cy="80" rx="35" ry="24" fill="#4caf50"/>
                    <ellipse cx="1120" cy="60" rx="38" ry="26" fill="#81c784"/>

                    <!-- Folhas finais -->
                    <ellipse cx="750" cy="120" rx="32" ry="22" fill="#66bb6a"/>
                    <ellipse cx="780" cy="100" rx="35" ry="24" fill="#4caf50"/>
                    <ellipse cx="720" cy="100" rx="38" ry="26" fill="#81c784"/>
                    <ellipse cx="760" cy="80" rx="32" ry="22" fill="#a5d6a7"/>
                    <ellipse cx="1250" cy="120" rx="32" ry="22" fill="#66bb6a"/>
                    <ellipse cx="1220" cy="100" rx="35" ry="24" fill="#4caf50"/>
                    <ellipse cx="1280" cy="100" rx="38" ry="26" fill="#81c784"/>
                    <ellipse cx="1240" cy="80" rx="32" ry="22" fill="#a5d6a7"/>
                </g>
            </svg>
        </div>

        <!-- Animação de transição para capítulos -->
        <div class="chapter-transition" id="chapterTransition">
            <div class="transition-content">
                <div class="transition-title" id="transitionTitle">Carregando...</div>
                <div class="transition-subtitle" id="transitionSubtitle">Preparando o capítulo</div>
                <div class="loading-animation"></div>
            </div>
        </div>

        <!-- Nomes das Abstrações Arrastáveis -->
        <div class="draggable-abstractions">
            <div class="abstraction-bubble disabled" draggable="false" data-abstraction="intuition">
                Intuição
            </div>
            <div class="abstraction-bubble disabled" draggable="false" data-abstraction="geometry">
                Geometria/Física
            </div>
            <div class="abstraction-bubble disabled" draggable="false" data-abstraction="analysis">
                Analogias
            </div>
            <div class="abstraction-bubble disabled" draggable="false" data-abstraction="topology">
                Abstração
            </div>
        </div>

        <!-- Perguntas Arrastáveis -->
        <div class="draggable-questions">
            <div class="question-bubble" draggable="true" data-question="integral">
                O que é?
            </div>
            <div class="question-bubble" draggable="true" data-question="area">
                Como?
            </div>
            <div class="question-bubble" draggable="true" data-question="parts">
                Por que?
            </div>
        </div>
    </div>

    <script>
        let isWithering = false;
        let rootQuestionsPlaced = 0;
        let trunkAbstractionsPlaced = 0;
        let currentStage = 1; // 1 = raízes, 2 = tronco, 3 = completo
        let draggedElement = null;
        
        // Ordem obrigatória das abstrações (de baixo para cima)
        const abstractionOrder = ['intuition', 'geometry', 'analysis', 'topology'];
        const placedAbstractions = [];
        
        // Tópicos do livro com links e tooltips
        const topics = [
            {
                title: "1. Introdução",
                link: "capitulos/cap1.html",
                tooltip: "Introdução ao cálculo integral avançado"
            },
            {
                title: "2. Integrais sobre Elementos",
                link: "capitulos/cap2.html",
                tooltip: "Integrais sobre elementos de área e volume"
            },
            {
                title: "3. Mecânica",
                link: "capitulos/cap3.html",
                tooltip: "Aplicações na mecânica clássica"
            },
            {
                title: "4. Trabalho e Energia",
                link: "capitulos/cap4.html",
                tooltip: "Trabalho e energia no espaço tridimensional"
            },
            {
                title: "5. Variação de Ângulo",
                link: "capitulos/cap5.html",
                tooltip: "Integral de linha e variação angular"
            },
            {
                title: "6. Campos - Fluxos",
                link: "capitulos/cap6.html",
                tooltip: "Teoria dos campos vetoriais"
            },
            {
                title: "7. Ângulo Sólido",
                link: "capitulos/cap7.html",
                tooltip: "Conceitos de ângulo sólido"
            },
            {
                title: "8. Determinante",
                link: "capitulos/cap8.html",
                tooltip: "Determinantes e transformações"
            },
            {
                title: "9. Voltando ao Trabalho",
                link: "capitulos/cap9.html",
                tooltip: "Revisitando conceitos de trabalho"
            },
            {
                title: "10. Bordo",
                link: "capitulos/cap10.html",
                tooltip: "Teoria de bordos e fronteiras"
            },
            {
                title: "11. Trabalho: Parte 2",
                link: "capitulos/cap11.html",
                tooltip: "Extensões da teoria do trabalho"
            },
            {
                title: "12. Teorema de Stokes",
                link: "capitulos/cap12.html",
                tooltip: "Teorema fundamental de Stokes"
            },
            {
                title: "13. Teorema de Green",
                link: "capitulos/cap13.html",
                tooltip: "Teorema de Green no plano"
            },
            {
                title: "14. Reinterpretando a Derivada",
                link: "capitulos/cap14.html",
                tooltip: "Nova perspectiva sobre derivadas"
            },
            {
                title: "15. Teorema da Divergência",
                link: "capitulos/cap15.html",
                tooltip: "Teorema da divergência de Gauss"
            },
            {
                title: "16. Álgebra Exterior",
                link: "capitulos/cap16.html",
                tooltip: "Fundamentos da álgebra exterior"
            },
            {
                title: "17. Pullback",
                link: "capitulos/cap17.html",
                tooltip: "Operações de pullback"
            },
            {
                title: "Apêndice A - Curvas",
                link: "capitulos/apendice-a.html",
                tooltip: "Curvas e superfícies paramétricas"
            },
            {
                title: "Apêndice B - Derivadas",
                link: "capitulos/apendice-b.html",
                tooltip: "Derivada como aproximação linear"
            },
            {
                title: "Apêndice C - Gradientes",
                link: "capitulos/apendice-c.html",
                tooltip: "Gradientes e derivadas direcionais"
            }
        ];

        // Posições melhor distribuídas pela árvore, sem sobreposição
        const leafPositions = [
            {x: 565, y: 60},    // 1. Prefácio (extremidade esquerda)
            {x: 645, y: 140},   // 2. Integrais sobre Elementos 
            {x: 725, y: 150},   // 3. Mecânica (galho principal esquerdo)
            {x: 790, y: 120},   // 4. Trabalho e Energia (galho médio esquerdo)
            {x: 838, y: 50},    // 5. Variação de Ângulo (galho superior esquerdo)
            {x: 805, y: 240},   // 6. Campos - Fluxos (ramificação esquerda)
            {x: 925, y: 375},   // 7. Ângulo Sólido (galho principal baixo esquerdo)
            {x: 975, y: 425},   // 8. Determinante (galho principal central)
            {x: 985, y: 220},   // 9. Voltando ao Trabalho (centro superior)
            {x: 1015, y: 280},  // 10. Bordo (centro médio)
            {x: 1025, y: 425},  // 11. Trabalho: Parte 2 (galho principal central direito)
            {x: 1075, y: 375},  // 12. Teorema de Stokes (galho principal baixo direito)
            {x: 1195, y: 240},  // 13. Teorema de Green (ramificação direita)
            {x: 1162, y: 50},   // 14. Reinterpretando Derivada (galho superior direito)
            {x: 1210, y: 120},  // 15. Teorema da Divergência (galho médio direito)
            {x: 1275, y: 150},  // 16. Álgebra Exterior (galho principal direito)
            {x: 1355, y: 140},  // 17. Pullback (meio-direita)
            {x: 685, y: 30},    // Apêndice A (topo esquerdo)
            {x: 1315, y: 30},   // Apêndice B (topo direito)
            {x: 1435, y: 60}    // Apêndice C (extremidade direita)
        ];

        // Função para navegar para capítulo com animação
        function navigateToChapter(topic) {
            const transition = document.getElementById('chapterTransition');
            const title = document.getElementById('transitionTitle');
            const subtitle = document.getElementById('transitionSubtitle');
            
            title.textContent = topic.title;
            subtitle.textContent = topic.tooltip;
            
            transition.classList.add('active');
            
            setTimeout(() => {
                window.location.href = topic.link;
            }, 2000);
        }

        function createLeafTopics() {
            leafPositions.forEach((pos, i) => {
                if (topics[i]) {
                    createLeafTopic(topics[i], pos.x, pos.y);
                }
            });
        }

        function createLeafTopic(topicData, x, y) {
            const topicEl = document.createElement('a');
            topicEl.className = 'leaf-topic';
            topicEl.textContent = topicData.title;
            topicEl.setAttribute('data-tooltip', topicData.tooltip);
            topicEl.href = '#';
            
            topicEl.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentStage >= 2) {
                    navigateToChapter(topicData);
                }
            });
            
            const container = document.getElementById('treeContainer');
            const viewBoxWidth = 2000;
            const viewBoxHeight = 1200;
            
            const leftPercent = (x / viewBoxWidth) * 100;
            const topPercent = (y / viewBoxHeight) * 100;
            
            topicEl.style.left = `${leftPercent}%`;
            topicEl.style.top = `${topPercent}%`;
            
            container.appendChild(topicEl);
        }

        function updateTrunkSlotAvailability() {
            const slots = document.querySelectorAll('.trunk-slot');
            const bubbles = document.querySelectorAll('.abstraction-bubble');
            
            // Determinar qual é o próximo slot disponível
            const nextOrder = trunkAbstractionsPlaced + 1;
            
            slots.forEach(slot => {
                const slotOrder = parseInt(slot.dataset.order);
                const slotAbstraction = slot.dataset.abstraction;
                
                if (slotOrder === nextOrder && !slot.classList.contains('filled')) {
                    // Este é o próximo slot disponível
                    slot.classList.remove('disabled', 'unavailable');
                    slot.textContent = 'Arraste o nome da camada';
                    
                    // Habilitar apenas a abstração correspondente
                    bubbles.forEach(bubble => {
                        if (bubble.dataset.abstraction === slotAbstraction) {
                            bubble.classList.remove('disabled', 'unavailable');
                            bubble.draggable = true;
                        } else if (!bubble.classList.contains('placed')) {
                            bubble.classList.add('unavailable');
                            bubble.draggable = false;
                        }
                    });
                } else if (slotOrder > nextOrder && !slot.classList.contains('filled')) {
                    // Slots futuros ficam indisponíveis
                    slot.classList.add('unavailable');
                    slot.classList.remove('disabled');
                    
                    const nextAbstraction = abstractionOrder[nextOrder - 1];
                    slot.textContent = `Coloque "${getAbstractionName(nextAbstraction)}" primeiro`;
                }
            });
        }

        function getAbstractionName(abstraction) {
            const names = {
                'intuition': 'Intuição',
                'geometry': 'Geometria/Física',
                'analysis': 'Analogias',
                'topology': 'Abstração'
            };
            return names[abstraction] || abstraction;
        }

        function enableTrunkSlots() {
            // Habilitar apenas o primeiro slot (Intuição)
            updateTrunkSlotAvailability();
        }

        function handleRootQuestionPlacement() {
            rootQuestionsPlaced++;
            
            if (rootQuestionsPlaced === 3) {
                currentStage = 2;
                enableTrunkSlots();
                revealLeaves(8);
            }
        }

        function handleTrunkAbstractionPlacement(abstractionType) {
            trunkAbstractionsPlaced++;
            placedAbstractions.push(abstractionType);
            
            // Revelar mais folhas baseado na quantidade colocada
            revealLeaves(8 + trunkAbstractionsPlaced * 5);
            
            // Atualizar disponibilidade dos próximos slots
            updateTrunkSlotAvailability();
            
            if (trunkAbstractionsPlaced === 4) {
                currentStage = 3;
                // Ativar botão de cortar raízes
                document.getElementById('seasonToggle').classList.add('active');
                
                // Mostrar todas as folhas
                setTimeout(() => {
                    const allLeaves = document.querySelectorAll('.leaves-group ellipse');
                    const allTopics = document.querySelectorAll('.leaf-topic');
                    
                    allLeaves.forEach((leaf, i) => {
                        setTimeout(() => {
                            leaf.classList.add('visible');
                            if (allTopics[i]) {
                                allTopics[i].classList.add('visible');
                            }
                        }, i * 15);
                    });
                }, 500);
            }
        }

        function revealLeaves(count) {
            const leaves = document.querySelectorAll('.leaves-group ellipse');
            const topics = document.querySelectorAll('.leaf-topic');
            
            const toReveal = Math.min(count, leaves.length);
            
            for (let i = 0; i < toReveal; i++) {
                setTimeout(() => {
                    leaves[i].classList.add('visible');
                    if (topics[i]) {
                        topics[i].classList.add('visible');
                    }
                }, i * 25);
            }
        }

        // Sistema de Drag and Drop
        let isDragging = false;
        let currentDragElement = null;
        let offset = { x: 0, y: 0 };

        function initializeDragAndDrop() {
            const questions = document.querySelectorAll('.question-bubble');
            const abstractions = document.querySelectorAll('.abstraction-bubble');
            const rootSlots = document.querySelectorAll('.root-slot');
            const trunkSlots = document.querySelectorAll('.trunk-slot');

            questions.forEach(question => {
                question.addEventListener('mousedown', startDrag);
                question.addEventListener('touchstart', startDrag, { passive: false });
            });

            abstractions.forEach(abstraction => {
                abstraction.addEventListener('mousedown', startDrag);
                abstraction.addEventListener('touchstart', startDrag, { passive: false });
            });

            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('touchend', endDrag);

            [...rootSlots, ...trunkSlots].forEach(slot => {
                slot.addEventListener('mouseenter', highlightSlot);
                slot.addEventListener('mouseleave', unhighlightSlot);
            });
        }

        function startDrag(e) {
            e.preventDefault();
            
            if (e.target.classList.contains('placed') || 
                e.target.classList.contains('disabled') || 
                e.target.classList.contains('unavailable')) return;
            
            isDragging = true;
            currentDragElement = e.target;
            currentDragElement.classList.add('dragging');
            
            const rect = currentDragElement.getBoundingClientRect();
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            
            offset.x = clientX - rect.left;
            offset.y = clientY - rect.top;
            
            currentDragElement.style.zIndex = '1000';
            currentDragElement.style.position = 'fixed';
            currentDragElement.style.pointerEvents = 'none';
            
            updateDragPosition(clientX, clientY);
        }

        function drag(e) {
            if (!isDragging || !currentDragElement) return;
            
            e.preventDefault();
            
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            
            updateDragPosition(clientX, clientY);
            
            const isQuestion = currentDragElement.classList.contains('question-bubble');
            const validSlots = isQuestion ? 
                document.querySelectorAll('.root-slot') : 
                document.querySelectorAll('.trunk-slot:not(.disabled):not(.unavailable)');
            
            let overSlot = null;
            
            validSlots.forEach(slot => {
                const slotRect = slot.getBoundingClientRect();
                if (clientX >= slotRect.left && clientX <= slotRect.right &&
                    clientY >= slotRect.top && clientY <= slotRect.bottom) {
                    overSlot = slot;
                }
            });
            
            validSlots.forEach(slot => {
                if (slot === overSlot && !slot.classList.contains('filled')) {
                    // Para abstrações, verificar se é a correta para este slot
                    if (!isQuestion) {
                        const slotAbstraction = slot.dataset.abstraction;
                        const dragAbstraction = currentDragElement.dataset.abstraction;
                        if (slotAbstraction === dragAbstraction) {
                            slot.classList.add('highlight');
                        }
                    } else {
                        slot.classList.add('highlight');
                    }
                } else {
                    slot.classList.remove('highlight');
                }
            });
        }

        function updateDragPosition(clientX, clientY) {
            if (!currentDragElement) return;
            
            currentDragElement.style.left = (clientX - offset.x) + 'px';
            currentDragElement.style.top = (clientY - offset.y) + 'px';
        }

        function endDrag(e) {
            if (!isDragging || !currentDragElement) return;
            
            const clientX = e.type.includes('touch') ? e.changedTouches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.changedTouches[0].clientY : e.clientY;
            
            const isQuestion = currentDragElement.classList.contains('question-bubble');
            const validSlots = isQuestion ? 
                document.querySelectorAll('.root-slot') : 
                document.querySelectorAll('.trunk-slot:not(.disabled):not(.unavailable)');
            
            let targetSlot = null;
            
            validSlots.forEach(slot => {
                const slotRect = slot.getBoundingClientRect();
                if (clientX >= slotRect.left && clientX <= slotRect.right &&
                    clientY >= slotRect.top && clientY <= slotRect.bottom &&
                    !slot.classList.contains('filled')) {
                    
                    // Para abstrações, verificar se é a correta para este slot
                    if (!isQuestion) {
                        const slotAbstraction = slot.dataset.abstraction;
                        const dragAbstraction = currentDragElement.dataset.abstraction;
                        if (slotAbstraction === dragAbstraction) {
                            targetSlot = slot;
                        }
                    } else {
                        targetSlot = slot;
                    }
                }
            });
            
            if (targetSlot) {
                if (isQuestion) {
                    placeQuestionInSlot(currentDragElement, targetSlot);
                } else {
                    placeAbstractionInSlot(currentDragElement, targetSlot);
                }
            } else {
                resetElementPosition(currentDragElement);
            }
            
            // Limpar estados
            currentDragElement.classList.remove('dragging');
            currentDragElement.style.zIndex = '';
            currentDragElement.style.position = '';
            currentDragElement.style.pointerEvents = '';
            currentDragElement.style.left = '';
            currentDragElement.style.top = '';
            
            validSlots.forEach(slot => slot.classList.remove('highlight'));
            
            isDragging = false;
            currentDragElement = null;
        }

        function placeQuestionInSlot(question, slot) {
            slot.classList.add('filled');
            slot.textContent = question.textContent;
            slot.style.fontSize = '9px';
            
            question.classList.add('placed');
            handleRootQuestionPlacement();
        }

        function placeAbstractionInSlot(abstraction, slot) {
            const abstractionType = abstraction.dataset.abstraction;
            
            slot.classList.add('filled');
            slot.textContent = abstraction.textContent;
            slot.style.fontSize = '10px';
            
            abstraction.classList.add('placed');
            handleTrunkAbstractionPlacement(abstractionType);
        }

        function resetElementPosition(element) {
            // Elemento volta para posição original automaticamente
        }

        function highlightSlot(e) {
            if (isDragging && !e.target.classList.contains('filled') && 
                !e.target.classList.contains('disabled') && 
                !e.target.classList.contains('unavailable')) {
                
                const isQuestion = currentDragElement?.classList.contains('question-bubble');
                const isRootSlot = e.target.classList.contains('root-slot');
                const isTrunkSlot = e.target.classList.contains('trunk-slot');
                
                if ((isQuestion && isRootSlot) || 
                    (!isQuestion && isTrunkSlot && 
                     e.target.dataset.abstraction === currentDragElement?.dataset.abstraction)) {
                    e.target.classList.add('highlight');
                }
            }
        }

        function unhighlightSlot(e) {
            e.target.classList.remove('highlight');
        }

        function cutRoots() {
            if (currentStage < 3) return;
            
            isWithering = !isWithering;
            const toggle = document.getElementById('seasonToggle');
            const treeContainer = document.getElementById('treeContainer');
            
            if (isWithering) {
                toggle.textContent = '🌱 Fazer Crescer';
                toggle.classList.add('cutting');
                treeContainer.classList.add('withering');
                
                // Animação das raízes murchando
                document.querySelectorAll('.root-path').forEach((root, i) => {
                    setTimeout(() => {
                        root.classList.add('withering');
                    }, i * 100);
                });
                
                // Folhas murchando
                document.querySelectorAll('.leaf-topic').forEach((el, i) => {
                    setTimeout(() => el.classList.remove('visible'), i * 8);
                });
                document.querySelectorAll('.leaves-group ellipse').forEach((el, i) => {
                    setTimeout(() => el.classList.add('withering'), i * 8);
                });
            } else {
                toggle.textContent = '✂️ Cortar Raízes';
                toggle.classList.remove('cutting');
                treeContainer.classList.remove('withering');
                
                // Animação das raízes crescendo de volta
                document.querySelectorAll('.root-path').forEach((root, i) => {
                    setTimeout(() => {
                        root.classList.remove('withering');
                    }, i * 100);
                });
                
                // Folhas voltando
                document.querySelectorAll('.leaf-topic').forEach((el, i) => {
                    setTimeout(() => el.classList.add('visible'), i * 8);
                });
                document.querySelectorAll('.leaves-group ellipse').forEach((el, i) => {
                    setTimeout(() => el.classList.remove('withering'), i * 8);
                });
            }
        }

        // Inicialização
        window.addEventListener('load', () => {
            createLeafTopics();
            initializeDragAndDrop();
            
            // Adicionar efeito de fade-in inicial
            setTimeout(() => {
                document.body.style.opacity = '1';
            }, 100);
        });

        // Prevenir navegação acidental durante drag
        document.addEventListener('dragstart', (e) => {
            e.preventDefault();
        });

        // Adicionar estilo inicial para fade-in
        document.body.style.opacity = '0';
        document.body.style.transition = 'opacity 0.5s ease';
    </script>
</body>
</html>